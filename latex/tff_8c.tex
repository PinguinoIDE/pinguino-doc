\hypertarget{tff_8c}{\section{/dvpt/pinguino/git/pinguino-\/libraries/p8/pinguino/libraries/sd/tff.c File Reference}
\label{tff_8c}\index{/dvpt/pinguino/git/pinguino-\/libraries/p8/pinguino/libraries/sd/tff.\-c@{/dvpt/pinguino/git/pinguino-\/libraries/p8/pinguino/libraries/sd/tff.\-c}}
}
{\ttfamily \#include $<$pic18fregs.\-h$>$}\\*
{\ttfamily \#include $<$stdio.\-h$>$}\\*
{\ttfamily \#include $<$string.\-h$>$}\\*
{\ttfamily \#include $<$sd\textbackslash{}tff.\-h$>$}\\*
{\ttfamily \#include $<$sd\textbackslash{}diskio.\-c$>$}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_af9bf08d8cf178eaf220d5b4e2370bcf6}{f\-\_\-mount} (\hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} drv, \hyperlink{struct_f_a_t_f_s}{F\-A\-T\-F\-S} $\ast$fs)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_aaf5d9d0358b6a5e5e2dc61ff69f308fc}{f\-\_\-open} (\hyperlink{struct_f_i_l}{F\-I\-L} $\ast$fp, const char $\ast$path, \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} mode)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_adc2cf56980d149befd982ae97c10ace1}{f\-\_\-read} (\hyperlink{struct_f_i_l}{F\-I\-L} $\ast$fp, void $\ast$buff, \hyperlink{p8_2pinguino_2core_2typedef_8h_abad51e07ab6d26bec9f1f786c8d65bcd}{word} btr, \hyperlink{p8_2pinguino_2core_2typedef_8h_abad51e07ab6d26bec9f1f786c8d65bcd}{word} $\ast$br)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_afe68f25170c6ab23400131b42bb34cf2}{f\-\_\-write} (\hyperlink{struct_f_i_l}{F\-I\-L} $\ast$fp, const void $\ast$buff, \hyperlink{p8_2pinguino_2core_2typedef_8h_abad51e07ab6d26bec9f1f786c8d65bcd}{word} btw, \hyperlink{p8_2pinguino_2core_2typedef_8h_abad51e07ab6d26bec9f1f786c8d65bcd}{word} $\ast$bw)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_ad69c7246b122ba56a134939ee0eaf847}{f\-\_\-sync} (\hyperlink{struct_f_i_l}{F\-I\-L} $\ast$fp)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_a53882db20ef4323dcfd1874d7733ffc3}{f\-\_\-close} (\hyperlink{struct_f_i_l}{F\-I\-L} $\ast$fp)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_ac04f1c36d80e2c3097ff4ad9d328bf2a}{f\-\_\-lseek} (\hyperlink{struct_f_i_l}{F\-I\-L} $\ast$fp, \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} ofs)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_a758444a30920784a7a1ac7dcd481bb1c}{f\-\_\-opendir} (\hyperlink{struct_d_i_r}{D\-I\-R} $\ast$\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, const char $\ast$path)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_a7fb1cd8728766e81e10339307e68a795}{f\-\_\-readdir} (\hyperlink{struct_d_i_r}{D\-I\-R} $\ast$\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, \hyperlink{struct_f_i_l_i_n_f_o}{F\-I\-L\-I\-N\-F\-O} $\ast$finfo)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_a26682b1b1f065f5d83b64713abdb0c45}{f\-\_\-stat} (const char $\ast$path, \hyperlink{struct_f_i_l_i_n_f_o}{F\-I\-L\-I\-N\-F\-O} $\ast$finfo)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_a691a27b40c348f7c84b42e911636f38a}{f\-\_\-truncate} (\hyperlink{struct_f_i_l}{F\-I\-L} $\ast$fp)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_a461a4663cbd92d479ad78449483d5cd1}{f\-\_\-getfree} (const char $\ast$drv, \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} $\ast$nclust, \hyperlink{struct_f_a_t_f_s}{F\-A\-T\-F\-S} $\ast$$\ast$fatfs)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_a8b0dc705b1e4820bee93ec58753f7368}{f\-\_\-unlink} (const char $\ast$path)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_a612a6f29c5d6f5ef7cf6213010dc2670}{f\-\_\-mkdir} (const char $\ast$path)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_a5fe807ad821d8b25e1dc8092dc9260b2}{f\-\_\-chmod} (const char $\ast$path, \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} value, \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} mask)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_a76c226618f3d211d722ab9db801d216d}{f\-\_\-utime} (const char $\ast$path, const \hyperlink{struct_f_i_l_i_n_f_o}{F\-I\-L\-I\-N\-F\-O} $\ast$finfo)
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_af87378f8760b74f1f13bc2b2f9eab7fa}{f\-\_\-rename} (const char $\ast$path\-\_\-old, const char $\ast$path\-\_\-new)
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{F\-R\-E\-S\-U\-L\-T} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res}
\item 
\hyperlink{struct_d_i_r}{D\-I\-R} \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}
\item 
char \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn} \mbox{[}12\mbox{]}
\item 
\hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} $\ast$ \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{tff_8c_a5fe807ad821d8b25e1dc8092dc9260b2}{\index{tff.\-c@{tff.\-c}!f\-\_\-chmod@{f\-\_\-chmod}}
\index{f\-\_\-chmod@{f\-\_\-chmod}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-chmod}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-chmod (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{path, }
\item[{{\bf byte}}]{value, }
\item[{{\bf byte}}]{mask}
\end{DoxyParamCaption}
)}}\label{tff_8c_a5fe807ad821d8b25e1dc8092dc9260b2}


Definition at line 1550 of file tff.\-c.


\begin{DoxyCode}
1555 \{
1556 \textcolor{comment}{//  FRESULT res;}
1557 \textcolor{comment}{//  DIR dj;}
1558 \textcolor{comment}{//  byte *dir;}
1559 \textcolor{comment}{//  char fn[8+3+1];}
1560 
1561 
1562     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = auto\_mount(&path, 1);
1563     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \{
1564         \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = trace\_path(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, path, &\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});    \textcolor{comment}{/* Trace the file path */}
1565         \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \{             \textcolor{comment}{/* Trace completed */}
1566             \textcolor{keywordflow}{if} (!\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}) \{
1567                 \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca83e45a4b579558c57192c0a391b9bb45}{FR\_INVALID\_NAME};    \textcolor{comment}{/* Root directory */}
1568             \} \textcolor{keywordflow}{else} \{
1569                 mask &= \hyperlink{pff_8h_add6d85d1e7a02b4f6188783ef91a5f1e}{AM\_RDO}|\hyperlink{pff_8h_aa90c4c921c1955fd407d8bbf17f1674e}{AM\_HID}|\hyperlink{pff_8h_a1f25d5c17b5a3a6397b3398add8cdc15}{AM\_SYS}|\hyperlink{pff_8h_ae8174d00798e34e7c9e95898cb9e1a09}{AM\_ARC};    \textcolor{comment}{/* Valid attribute mask */}
1570                 \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] = (value & mask) | (\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] & (
      \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte})~mask);    \textcolor{comment}{/* Apply attribute change */}
1571                 \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = sync();
1572             \}
1573         \}
1574     \}
1575     \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1576 \}
\end{DoxyCode}
\hypertarget{tff_8c_a53882db20ef4323dcfd1874d7733ffc3}{\index{tff.\-c@{tff.\-c}!f\-\_\-close@{f\-\_\-close}}
\index{f\-\_\-close@{f\-\_\-close}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-close}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-close (
\begin{DoxyParamCaption}
\item[{{\bf F\-I\-L} $\ast$}]{fp}
\end{DoxyParamCaption}
)}}\label{tff_8c_a53882db20ef4323dcfd1874d7733ffc3}


Definition at line 1098 of file tff.\-c.


\begin{DoxyCode}
1101 \{
1102 \textcolor{comment}{//  FRESULT res;}
1103 
1104 
1105 \textcolor{preprocessor}{#if !\_FS\_READONLY}
1106 \textcolor{preprocessor}{}    \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = \hyperlink{tff_8c_ad69c7246b122ba56a134939ee0eaf847}{f\_sync}(fp);
1107 \textcolor{preprocessor}{#else}
1108 \textcolor{preprocessor}{}    \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = validate(fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}, fp->\hyperlink{struct_f_i_l_a588688f55d57bf8a7e8c1d2cf88a3c56}{id});
1109 \textcolor{preprocessor}{#endif}
1110 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs} = \hyperlink{p8_2pinguino_2core_2const_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1111     \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1112 \}
\end{DoxyCode}
\hypertarget{tff_8c_a461a4663cbd92d479ad78449483d5cd1}{\index{tff.\-c@{tff.\-c}!f\-\_\-getfree@{f\-\_\-getfree}}
\index{f\-\_\-getfree@{f\-\_\-getfree}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-getfree}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-getfree (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{drv, }
\item[{{\bf dword} $\ast$}]{nclust, }
\item[{{\bf F\-A\-T\-F\-S} $\ast$$\ast$}]{fatfs}
\end{DoxyParamCaption}
)}}\label{tff_8c_a461a4663cbd92d479ad78449483d5cd1}


Definition at line 1359 of file tff.\-c.



Referenced by sd\-\_\-status().


\begin{DoxyCode}
1364 \{
1365 \textcolor{comment}{//  FRESULT res;}
1366     \hyperlink{struct_f_a_t_f_s}{FATFS} *fs;
1367     \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} n, sect;
1368     \hyperlink{tff_8h_af322b62389c843d5727de4796a09f59c}{CLUST} clust;
1369     \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} fat, f, *p;
1370 
1371 
1372     \textcolor{comment}{/* Get drive number */}
1373     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = auto\_mount(&drv, 0);
1374     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1375     *fatfs = fs = FatFs;
1376 
1377     \textcolor{comment}{/* If number of free cluster is valid, return it without cluster scan. */}
1378     \textcolor{keywordflow}{if} (fs->\hyperlink{struct_f_a_t_f_s_a7976c77220d4840b68e2aef308c770e5}{free\_clust} <= fs->\hyperlink{struct_f_a_t_f_s_aa628566fa0882ed951ed01fc6f20ff1b}{max\_clust} - 2) \{
1379         *nclust = fs->\hyperlink{struct_f_a_t_f_s_a7976c77220d4840b68e2aef308c770e5}{free\_clust};
1380         \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK};
1381     \}
1382 
1383     \textcolor{comment}{/* Get number of free clusters */}
1384     fat = fs->\hyperlink{struct_f_a_t_f_s_aee58d0bf64f06146927e78ad026b06ac}{fs\_type};
1385     n = 0;
1386     \textcolor{keywordflow}{if} (fat == \hyperlink{pff_8h_aab755aa1b4f81f4aabee4a5d4738cfb0}{FS\_FAT12}) \{
1387         clust = 2;
1388         \textcolor{keywordflow}{do} \{
1389             \textcolor{keywordflow}{if} ((\hyperlink{p8_2pinguino_2core_2typedef_8h_abad51e07ab6d26bec9f1f786c8d65bcd}{word})get\_cluster(clust) == 0) n++;
1390         \} \textcolor{keywordflow}{while} (++clust < fs->max\_clust);
1391     \} \textcolor{keywordflow}{else} \{
1392         clust = fs->\hyperlink{struct_f_a_t_f_s_aa628566fa0882ed951ed01fc6f20ff1b}{max\_clust};
1393         sect = fs->\hyperlink{struct_f_a_t_f_s_a4c158f002bd87f70c1595baef8888d96}{fatbase};
1394         f = 0; p = 0;
1395         \textcolor{keywordflow}{do} \{
1396             \textcolor{keywordflow}{if} (!f) \{
1397                 \textcolor{keywordflow}{if} (!move\_window(sect++)) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1398                 p = fs->\hyperlink{struct_f_a_t_f_s_a54541860d8273ee2709def80ccc3e271}{win};
1399             \}
1400             \textcolor{keywordflow}{if} (!\hyperlink{tff_8h_a79fae83d3d8fd0b344b0e882b1f815dd}{\_FAT32} || fat == \hyperlink{pff_8h_a7ef90a36d99edfc0138a2155a17a79b9}{FS\_FAT16}) \{
1401                 \textcolor{keywordflow}{if} (\hyperlink{pff_8h_a398519bb08da6457e62567d1f0b567e3}{LD\_WORD}(p) == 0) n++;
1402                 p += 2; f += 1;
1403             \} \textcolor{keywordflow}{else} \{
1404                 \textcolor{keywordflow}{if} (\hyperlink{pff_8h_a4690304ddc975516f7dc02575c96e34e}{LD\_DWORD}(p) == 0) n++;
1405                 p += 4; f += 2;
1406             \}
1407         \} \textcolor{keywordflow}{while} (--clust);
1408     \}
1409     fs->\hyperlink{struct_f_a_t_f_s_a7976c77220d4840b68e2aef308c770e5}{free\_clust} = n;
1410 \textcolor{preprocessor}{#if \_USE\_FSINFO}
1411 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (fat == \hyperlink{pff_8h_ac63e0796095a789cefdbc3c3c676c9ce}{FS\_FAT32}) fs->\hyperlink{struct_f_a_t_f_s_a7f248fa8f63ffcdabc347bc9467ec9bf}{fsi\_flag} = 1;
1412 \textcolor{preprocessor}{#endif}
1413 \textcolor{preprocessor}{}
1414     *nclust = n;
1415     \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK};
1416 \}
\end{DoxyCode}
\hypertarget{tff_8c_ac04f1c36d80e2c3097ff4ad9d328bf2a}{\index{tff.\-c@{tff.\-c}!f\-\_\-lseek@{f\-\_\-lseek}}
\index{f\-\_\-lseek@{f\-\_\-lseek}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-lseek}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-lseek (
\begin{DoxyParamCaption}
\item[{{\bf F\-I\-L} $\ast$}]{fp, }
\item[{{\bf dword}}]{ofs}
\end{DoxyParamCaption}
)}}\label{tff_8c_ac04f1c36d80e2c3097ff4ad9d328bf2a}


Definition at line 1122 of file tff.\-c.


\begin{DoxyCode}
1126 \{
1127 \textcolor{comment}{//  FRESULT res;}
1128     \hyperlink{tff_8h_af322b62389c843d5727de4796a09f59c}{CLUST} clust;
1129     \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} csize, ifptr;
1130 
1131 
1132     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = validate(fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}, fp->\hyperlink{struct_f_i_l_a588688f55d57bf8a7e8c1d2cf88a3c56}{id});          \textcolor{comment}{/* Check validity of the object */}
1133     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1134     \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} & \hyperlink{tff_8h_ad3b47fe8126573b17752a9a242b76b9a}{FA\_\_ERROR}) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1135     \textcolor{keywordflow}{if} (ofs > fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize}                    \textcolor{comment}{/* In read-only mode, clip offset with the file size */}
1136 #\textcolor{keywordflow}{if} !\hyperlink{tff_8h_afb8d35370cfe0c23832ac2d82e854ec6}{\_FS\_READONLY}
1137          && !(fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} & \hyperlink{tff_8h_afa366963220c89b882c0361794020c14}{FA\_WRITE})
1138 #endif
1139         ) ofs = fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize};
1140 
1141     ifptr = fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr};
1142     fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} = 0; fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} = 255;
1143     \textcolor{keywordflow}{if} (ofs > 0) \{
1144         csize = (\hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword})fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_af8143a50ac7be72544022dd46a7013da}{csize} * 512U;        \textcolor{comment}{/* Cluster size (byte) */}
1145         \hyperlink{p8_2pinguino_2libraries_2_p_c_d8544_8c_af84ca11bf86c56a1f74027a99d48218d}{if} (ifptr > 0 &&
1146             (ofs - 1) / csize >= (ifptr - 1) / csize) \{\textcolor{comment}{/* When seek to same or following cluster, */}
1147             fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} = (ifptr - 1) & ~(csize - 1);  \textcolor{comment}{/* start from the current cluster */}
1148             ofs -= fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr};
1149             clust = fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust};
1150         \} \textcolor{keywordflow}{else} \{                                    \textcolor{comment}{/* When seek to back cluster, */}
1151             clust = fp->\hyperlink{struct_f_i_l_a5203f761bacf25758b7e736215f74349}{org\_clust};                 \textcolor{comment}{/* start from the first cluster */}
1152 \textcolor{preprocessor}{#if !\_FS\_READONLY}
1153 \textcolor{preprocessor}{}            \textcolor{keywordflow}{if} (clust == 0) \{                       \textcolor{comment}{/* If no cluster chain, create a new chain */}
1154                 clust = create\_chain(0);
1155                 \textcolor{keywordflow}{if} (clust == 1) \textcolor{keywordflow}{goto} fk\_error;
1156                 fp->\hyperlink{struct_f_i_l_a5203f761bacf25758b7e736215f74349}{org\_clust} = clust;
1157             \}
1158 \textcolor{preprocessor}{#endif}
1159 \textcolor{preprocessor}{}            fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust} = clust;
1160         \}
1161         \textcolor{keywordflow}{if} (clust != 0) \{
1162             \textcolor{keywordflow}{while} (ofs > csize) \{                   \textcolor{comment}{/* Cluster following loop */}
1163 \textcolor{preprocessor}{#if !\_FS\_READONLY}
1164 \textcolor{preprocessor}{}                \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} & \hyperlink{tff_8h_afa366963220c89b882c0361794020c14}{FA\_WRITE}) \{          \textcolor{comment}{/* Check if in write mode or not */}
1165                     clust = create\_chain(clust);    \textcolor{comment}{/* Force streached if in write mode */}
1166                     \textcolor{keywordflow}{if} (clust == 0) \{               \textcolor{comment}{/* When disk gets full, clip file size */}
1167                         ofs = csize; \textcolor{keywordflow}{break};
1168                     \}
1169                 \} \textcolor{keywordflow}{else}
1170 \textcolor{preprocessor}{#endif}
1171 \textcolor{preprocessor}{}                    clust = get\_cluster(clust);     \textcolor{comment}{/* Follow cluster chain if not in write mode */}
1172                 \textcolor{keywordflow}{if} (clust < 2 || clust >= fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_aa628566fa0882ed951ed01fc6f20ff1b}{max\_clust}) \textcolor{keywordflow}{goto} fk\_error;
1173                 fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust} = clust;
1174                 fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} += csize;
1175                 ofs -= csize;
1176             \}
1177             fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} += ofs;
1178             fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} = (\hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte})(ofs / 512U);    \textcolor{comment}{/* Sector offset in the cluster */}
1179             \textcolor{keywordflow}{if} (ofs % 512U) fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect}++;
1180         \}
1181     \}
1182 
1183 \textcolor{preprocessor}{#if !\_FS\_READONLY}
1184 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} > fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize}) \{            \textcolor{comment}{/* Set changed flag if the file was extended */}
1185         fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize} = fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr};
1186         fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} |= \hyperlink{tff_8h_ac4b7d5223f84df91c306ffbff536fae4}{FA\_\_WRITTEN};
1187     \}
1188 \textcolor{preprocessor}{#endif}
1189 \textcolor{preprocessor}{}
1190     \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK};
1191 
1192 fk\_error:   \textcolor{comment}{/* Abort this file due to an unrecoverable error */}
1193     fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} |= \hyperlink{tff_8h_ad3b47fe8126573b17752a9a242b76b9a}{FA\_\_ERROR};
1194     \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1195 \}
\end{DoxyCode}
\hypertarget{tff_8c_a612a6f29c5d6f5ef7cf6213010dc2670}{\index{tff.\-c@{tff.\-c}!f\-\_\-mkdir@{f\-\_\-mkdir}}
\index{f\-\_\-mkdir@{f\-\_\-mkdir}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-mkdir}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-mkdir (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{path}
\end{DoxyParamCaption}
)}}\label{tff_8c_a612a6f29c5d6f5ef7cf6213010dc2670}


Definition at line 1478 of file tff.\-c.


\begin{DoxyCode}
1481 \{
1482 \textcolor{comment}{//  FRESULT res;}
1483 \textcolor{comment}{//  DIR dj;}
1484 \textcolor{comment}{//  byte *dir;}
1485     \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} *fw, n;
1486 \textcolor{comment}{//  char fn[8+3+1];}
1487     \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} sect, dsect, tim;
1488     \hyperlink{tff_8h_af322b62389c843d5727de4796a09f59c}{CLUST} dclust, pclust;
1489 
1490 
1491     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = auto\_mount(&path, 1);
1492     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1493     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = trace\_path(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, path, &\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});    \textcolor{comment}{/* Trace the file path */}
1494     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca0d8f024d256df76e84782b95018a2450}{FR\_EXIST};      \textcolor{comment}{/* Any file or directory is already existing */}
1495     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca97da8f98fc2e66d8fa7847f9ebb19b8c}{FR\_NO\_FILE}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1496 
1497     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = reserve\_direntry(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, &\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});      \textcolor{comment}{/* Reserve a directory entry */}
1498     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1499     sect = \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a5ee19a26d1dfd79d52fbba59cc792da3}{winsect};
1500     dclust = create\_chain(0);               \textcolor{comment}{/* Allocate a cluster for new directory table */}
1501     \textcolor{keywordflow}{if} (dclust == 1) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1502     dsect = \hyperlink{ff_8c_a7519abb60fe91f6aa1d17f64fbae123a}{clust2sect}(dclust);
1503     \textcolor{keywordflow}{if} (!dsect) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca897e9f2dd7629a80f48af242d8bc1a3d}{FR\_DENIED};
1504     \textcolor{keywordflow}{if} (!move\_window(dsect)) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1505 
1506     fw = \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a54541860d8273ee2709def80ccc3e271}{win};
1507     memset((\textcolor{keywordtype}{void} *)fw, 0, 512U);                    \textcolor{comment}{/* Clear the directory table */}
1508     \textcolor{keywordflow}{for} (n = 1; n < \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_af8143a50ac7be72544022dd46a7013da}{csize}; n++) \{
1509         \textcolor{keywordflow}{if} (\hyperlink{p8_2pinguino_2libraries_2sd_2diskio_8h_a7ffe0ccc946550a260d00871c6b636e7}{disk\_write}(fw, ++dsect, 1) != \hyperlink{p8_2pinguino_2libraries_2sd_2diskio_8h_aacdfef1dad6565f65c26d12fe0ea4b2ba2ea4b6ef3fffc17dd1d38ab5c2837737}{RES\_OK})
1510             \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1511     \}
1512 
1513     memset(&fw[\hyperlink{pff_8h_afa89348e9fc2de82ae9e12c661366b0e}{DIR\_Name}], \textcolor{charliteral}{' '}, 8+3);        \textcolor{comment}{/* Create "." entry */}
1514     fw[\hyperlink{pff_8h_afa89348e9fc2de82ae9e12c661366b0e}{DIR\_Name}] = \textcolor{charliteral}{'.'};
1515     fw[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] = \hyperlink{pff_8h_a3a9db44e978ed6c13b641e092d4cd7d3}{AM\_DIR};
1516     tim = \hyperlink{tff_8h_a489f23a9be58cd896a5c45e45c6e6e6f}{get\_fattime}();
1517     \hyperlink{pff_8h_abf5aba973d95ac5843b80aa7379cdd66}{ST\_DWORD}(&fw[\hyperlink{pff_8h_ab9452d336adeece2a1b0b54ab35b8a59}{DIR\_WrtTime}], tim);
1518     memcpy(&fw[32], &fw[0], 32); fw[33] = \textcolor{charliteral}{'.'};  \textcolor{comment}{/* Create ".." entry */}
1519     pclust = \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_aada1acd6ce100ead798e712b18c49547}{sclust};
1520 \textcolor{preprocessor}{#if \_FAT32}
1521 \textcolor{preprocessor}{}    \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&fw[   \hyperlink{pff_8h_a0bc29c3f09e1e9c40c414f7d50d7905c}{DIR\_FstClusHI}], dclust >> 16);
1522     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_aee58d0bf64f06146927e78ad026b06ac}{fs\_type} == \hyperlink{pff_8h_ac63e0796095a789cefdbc3c3c676c9ce}{FS\_FAT32} && pclust == \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->
      \hyperlink{struct_f_a_t_f_s_a2152449dba421b7671f09ec7fcc7fa4e}{dirbase}) pclust = 0;
1523     \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&fw[32+\hyperlink{pff_8h_a0bc29c3f09e1e9c40c414f7d50d7905c}{DIR\_FstClusHI}], pclust >> 16);
1524 \textcolor{preprocessor}{#endif}
1525 \textcolor{preprocessor}{}    \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&fw[   \hyperlink{pff_8h_aebe0e913bff75a89d38dbcb04baf5dff}{DIR\_FstClusLO}], dclust);
1526     \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&fw[32+\hyperlink{pff_8h_aebe0e913bff75a89d38dbcb04baf5dff}{DIR\_FstClusLO}], pclust);
1527     \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_ac310e0b372e8ec4195568846746d2f49}{winflag} = 1;
1528 
1529     \textcolor{keywordflow}{if} (!move\_window(sect)) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1530     memset(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[0], 0, 32);                      \textcolor{comment}{/* Clean-up the new entry */}
1531     memcpy(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_afa89348e9fc2de82ae9e12c661366b0e}{DIR\_Name}], \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, 8+3);           \textcolor{comment}{/* Name */}
1532     \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_a87ee1f701c2ab941862e3ce00c1c1e9d}{DIR\_NTres}] = \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}[11];
1533     \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] = \hyperlink{pff_8h_a3a9db44e978ed6c13b641e092d4cd7d3}{AM\_DIR};                        \textcolor{comment}{/* Attribute */}
1534     \hyperlink{pff_8h_abf5aba973d95ac5843b80aa7379cdd66}{ST\_DWORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ab9452d336adeece2a1b0b54ab35b8a59}{DIR\_WrtTime}], tim);         \textcolor{comment}{/* Crated time */}
1535     \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_aebe0e913bff75a89d38dbcb04baf5dff}{DIR\_FstClusLO}], dclust);        \textcolor{comment}{/* Table start cluster */}
1536 \textcolor{preprocessor}{#if \_FAT32}
1537 \textcolor{preprocessor}{}    \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_a0bc29c3f09e1e9c40c414f7d50d7905c}{DIR\_FstClusHI}], dclust >> 16);
1538 \textcolor{preprocessor}{#endif}
1539 \textcolor{preprocessor}{}
1540     \textcolor{keywordflow}{return} sync();
1541 \}
\end{DoxyCode}
\hypertarget{tff_8c_af9bf08d8cf178eaf220d5b4e2370bcf6}{\index{tff.\-c@{tff.\-c}!f\-\_\-mount@{f\-\_\-mount}}
\index{f\-\_\-mount@{f\-\_\-mount}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-mount}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-mount (
\begin{DoxyParamCaption}
\item[{{\bf byte}}]{drv, }
\item[{{\bf F\-A\-T\-F\-S} $\ast$}]{fs}
\end{DoxyParamCaption}
)}}\label{tff_8c_af9bf08d8cf178eaf220d5b4e2370bcf6}


Definition at line 796 of file tff.\-c.



Referenced by mount(), and unmount().


\begin{DoxyCode}
800 \{
801     \textcolor{keywordflow}{if} (drv) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca487844af77de15f6932a3b41ef3a2d65}{FR\_INVALID\_DRIVE};
802 
803     \textcolor{keywordflow}{if} (FatFs) FatFs->\hyperlink{struct_f_a_t_f_s_aee58d0bf64f06146927e78ad026b06ac}{fs\_type} = 0;   \textcolor{comment}{/* Clear old object */}
804 
805     FatFs = fs;                 \textcolor{comment}{/* Register and clear new object */}
806     \textcolor{keywordflow}{if} (fs) fs->\hyperlink{struct_f_a_t_f_s_aee58d0bf64f06146927e78ad026b06ac}{fs\_type} = 0;
807 
808     \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK};
809 \}
\end{DoxyCode}
\hypertarget{tff_8c_aaf5d9d0358b6a5e5e2dc61ff69f308fc}{\index{tff.\-c@{tff.\-c}!f\-\_\-open@{f\-\_\-open}}
\index{f\-\_\-open@{f\-\_\-open}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-open}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-open (
\begin{DoxyParamCaption}
\item[{{\bf F\-I\-L} $\ast$}]{fp, }
\item[{const char $\ast$}]{path, }
\item[{{\bf byte}}]{mode}
\end{DoxyParamCaption}
)}}\label{tff_8c_aaf5d9d0358b6a5e5e2dc61ff69f308fc}


Definition at line 818 of file tff.\-c.


\begin{DoxyCode}
823 \{
824 \textcolor{comment}{//  FRESULT res;}
825 \textcolor{comment}{//  DIR dj;}
826 \textcolor{comment}{//  byte *dir;}
827 \textcolor{comment}{//  char fn[8+3+1];}
828 
829 
830     fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs} = \hyperlink{p8_2pinguino_2core_2const_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};        \textcolor{comment}{/* Clear file object */}
831 \textcolor{preprocessor}{#if !\_FS\_READONLY}
832 \textcolor{preprocessor}{}    mode &= (\hyperlink{tff_8h_a1f4f3530ff03abbd979b072536e72290}{FA\_READ}|\hyperlink{tff_8h_afa366963220c89b882c0361794020c14}{FA\_WRITE}|\hyperlink{tff_8h_afba4546b131dea4b24727fa20a80e29f}{FA\_CREATE\_ALWAYS}|
      \hyperlink{tff_8h_a17b01553029920ac0468912b4bcb16c7}{FA\_OPEN\_ALWAYS}|\hyperlink{tff_8h_a417bb1babd1785fd181a806b5613eba3}{FA\_CREATE\_NEW});
833     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = auto\_mount(&path, (\hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte})(mode & (\hyperlink{tff_8h_afa366963220c89b882c0361794020c14}{FA\_WRITE}|
      \hyperlink{tff_8h_afba4546b131dea4b24727fa20a80e29f}{FA\_CREATE\_ALWAYS}|\hyperlink{tff_8h_a17b01553029920ac0468912b4bcb16c7}{FA\_OPEN\_ALWAYS}|\hyperlink{tff_8h_a417bb1babd1785fd181a806b5613eba3}{FA\_CREATE\_NEW})));
834 \textcolor{preprocessor}{#else}
835 \textcolor{preprocessor}{}    mode &= \hyperlink{tff_8h_a1f4f3530ff03abbd979b072536e72290}{FA\_READ};
836     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = auto\_mount(&path, 0);
837 \textcolor{preprocessor}{#endif}
838 \textcolor{preprocessor}{}    \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
839     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = trace\_path(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, path, &\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});    \textcolor{comment}{/* Trace the file path */}
840 
841 \textcolor{preprocessor}{#if !\_FS\_READONLY}
842 \textcolor{preprocessor}{}    \textcolor{comment}{/* Create or Open a File */}
843     \textcolor{keywordflow}{if} (mode & (\hyperlink{tff_8h_afba4546b131dea4b24727fa20a80e29f}{FA\_CREATE\_ALWAYS}|\hyperlink{tff_8h_a17b01553029920ac0468912b4bcb16c7}{FA\_OPEN\_ALWAYS}|
      \hyperlink{tff_8h_a417bb1babd1785fd181a806b5613eba3}{FA\_CREATE\_NEW})) \{
844         \hyperlink{tff_8h_af322b62389c843d5727de4796a09f59c}{CLUST} rs;
845         \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} dw;
846         \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \{     \textcolor{comment}{/* No file, create new */}
847             \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca97da8f98fc2e66d8fa7847f9ebb19b8c}{FR\_NO\_FILE}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
848             \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = reserve\_direntry(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, &\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});
849             \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
850             memset((\textcolor{keywordtype}{void} *)\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}, 0, 32);      \textcolor{comment}{/* Initialize the new entry with open name */}
851             memcpy(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_afa89348e9fc2de82ae9e12c661366b0e}{DIR\_Name}], \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, 8+3);
852             \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_a87ee1f701c2ab941862e3ce00c1c1e9d}{DIR\_NTres}] = \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}[11];
853             mode |= \hyperlink{tff_8h_afba4546b131dea4b24727fa20a80e29f}{FA\_CREATE\_ALWAYS};
854         \}
855         \textcolor{keywordflow}{else} \{                  \textcolor{comment}{/* Any object is already existing */}
856             \textcolor{keywordflow}{if} (mode & \hyperlink{tff_8h_a417bb1babd1785fd181a806b5613eba3}{FA\_CREATE\_NEW})          \textcolor{comment}{/* Cannot create new */}
857                 \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca0d8f024d256df76e84782b95018a2450}{FR\_EXIST};
858             \textcolor{keywordflow}{if} (!\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir} || (\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] & (\hyperlink{pff_8h_add6d85d1e7a02b4f6188783ef91a5f1e}{AM\_RDO}|\hyperlink{pff_8h_a3a9db44e978ed6c13b641e092d4cd7d3}{AM\_DIR})))    \textcolor{comment}{/* Cannot overwrite
       (R/O or DIR) */}
859                 \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca897e9f2dd7629a80f48af242d8bc1a3d}{FR\_DENIED};
860             \textcolor{keywordflow}{if} (mode & \hyperlink{tff_8h_afba4546b131dea4b24727fa20a80e29f}{FA\_CREATE\_ALWAYS}) \{      \textcolor{comment}{/* Resize it to zero */}
861 \textcolor{preprocessor}{#if \_FAT32}
862 \textcolor{preprocessor}{}                rs = ((\hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword})\hyperlink{pff_8h_a398519bb08da6457e62567d1f0b567e3}{LD\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_a0bc29c3f09e1e9c40c414f7d50d7905c}{DIR\_FstClusHI}]) << 16) | 
      \hyperlink{pff_8h_a398519bb08da6457e62567d1f0b567e3}{LD\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_aebe0e913bff75a89d38dbcb04baf5dff}{DIR\_FstClusLO}]);
863                 \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[DIR\_FstClusHI], 0);
864 \textcolor{preprocessor}{#else}
865 \textcolor{preprocessor}{}                rs = \hyperlink{pff_8h_a398519bb08da6457e62567d1f0b567e3}{LD\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[DIR\_FstClusLO]);
866 \textcolor{preprocessor}{#endif}
867 \textcolor{preprocessor}{}                \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[DIR\_FstClusLO], 0);  \textcolor{comment}{/* cluster = 0 */}
868                 \hyperlink{pff_8h_abf5aba973d95ac5843b80aa7379cdd66}{ST\_DWORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_abfbfa613864a02a65f0bf70ead6672c7}{DIR\_FileSize}], 0); \textcolor{comment}{/* size = 0 */}
869                 \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_ac310e0b372e8ec4195568846746d2f49}{winflag} = 1;
870                 dw = \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a5ee19a26d1dfd79d52fbba59cc792da3}{winsect};         \textcolor{comment}{/* Remove the cluster chain */}
871                 \textcolor{keywordflow}{if} (!remove\_chain(rs) || !move\_window(dw))
872                     \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
873                 \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a07b2a137b54c6c95ffcee006c8906429}{last\_clust} = rs - 1;       \textcolor{comment}{/* Reuse the cluster hole */}
874             \}
875         \}
876         \textcolor{keywordflow}{if} (mode & FA\_CREATE\_ALWAYS) \{
877             \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] = 0;                   \textcolor{comment}{/* Reset attribute */}
878             dw = \hyperlink{tff_8h_a489f23a9be58cd896a5c45e45c6e6e6f}{get\_fattime}();
879             \hyperlink{pff_8h_abf5aba973d95ac5843b80aa7379cdd66}{ST\_DWORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_a47fb1881ea71d860db9b8280564cb4d5}{DIR\_CrtTime}], dw);  \textcolor{comment}{/* Created time */}
880             \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_ac310e0b372e8ec4195568846746d2f49}{winflag} = 1;
881             mode |= \hyperlink{tff_8h_ac4b7d5223f84df91c306ffbff536fae4}{FA\_\_WRITTEN};             \textcolor{comment}{/* Set file changed flag */}
882         \}
883     \}
884     \textcolor{comment}{/* Open an existing file */}
885     \textcolor{keywordflow}{else} \{
886 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* !\_FS\_READONLY */}\textcolor{preprocessor}{}
887 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};            \textcolor{comment}{/* Trace failed */}
888         \textcolor{keywordflow}{if} (!\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir} || (\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] & \hyperlink{pff_8h_a3a9db44e978ed6c13b641e092d4cd7d3}{AM\_DIR}))   \textcolor{comment}{/* It is a directory */}
889             \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca97da8f98fc2e66d8fa7847f9ebb19b8c}{FR\_NO\_FILE};
890 \textcolor{preprocessor}{#if !\_FS\_READONLY}
891 \textcolor{preprocessor}{}        \textcolor{keywordflow}{if} ((mode & \hyperlink{tff_8h_afa366963220c89b882c0361794020c14}{FA\_WRITE}) && (\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] & \hyperlink{pff_8h_add6d85d1e7a02b4f6188783ef91a5f1e}{AM\_RDO})) \textcolor{comment}{/* R/O violation */}
892             \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca897e9f2dd7629a80f48af242d8bc1a3d}{FR\_DENIED};
893     \}
894     fp->\hyperlink{struct_f_i_l_ac40d4a51f8f940e6154d364c45935278}{dir\_sect} = \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a5ee19a26d1dfd79d52fbba59cc792da3}{winsect};       \textcolor{comment}{/* Pointer to the directory entry */}
895     fp->\hyperlink{struct_f_i_l_abc0a41dfbb69ffc78a01f5a357412995}{dir\_ptr} = \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir};
896 \textcolor{preprocessor}{#endif}
897 \textcolor{preprocessor}{}    fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} = mode;                    \textcolor{comment}{/* File access mode */}
898     fp->\hyperlink{struct_f_i_l_a5203f761bacf25758b7e736215f74349}{org\_clust} =                        \textcolor{comment}{/* File start cluster */}
899 \textcolor{preprocessor}{#if \_FAT32}
900 \textcolor{preprocessor}{}        ((\hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword})\hyperlink{pff_8h_a398519bb08da6457e62567d1f0b567e3}{LD\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[DIR\_FstClusHI]) << 16) |
901 #endif
902         \hyperlink{pff_8h_a398519bb08da6457e62567d1f0b567e3}{LD\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[DIR\_FstClusLO]);
903     fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize} = \hyperlink{pff_8h_a4690304ddc975516f7dc02575c96e34e}{LD\_DWORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_abfbfa613864a02a65f0bf70ead6672c7}{DIR\_FileSize}]);   \textcolor{comment}{/* File size */}
904     fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} = 0; fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} = 255;     \textcolor{comment}{/* File pointer */}
905     fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs} = \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}; fp->\hyperlink{struct_f_i_l_a588688f55d57bf8a7e8c1d2cf88a3c56}{id} = \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a588688f55d57bf8a7e8c1d2cf88a3c56}{id};   \textcolor{comment}{/* Owner file system object of the file */}
906     \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK};
907 \}
\end{DoxyCode}
\hypertarget{tff_8c_a758444a30920784a7a1ac7dcd481bb1c}{\index{tff.\-c@{tff.\-c}!f\-\_\-opendir@{f\-\_\-opendir}}
\index{f\-\_\-opendir@{f\-\_\-opendir}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-opendir}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-opendir (
\begin{DoxyParamCaption}
\item[{{\bf D\-I\-R} $\ast$}]{dj, }
\item[{const char $\ast$}]{path}
\end{DoxyParamCaption}
)}}\label{tff_8c_a758444a30920784a7a1ac7dcd481bb1c}


Definition at line 1205 of file tff.\-c.



Referenced by list\-Dir(), and scan\-\_\-files().


\begin{DoxyCode}
1209 \{
1210 \textcolor{comment}{//  FRESULT res;}
1211 \textcolor{comment}{//  byte *dir;}
1212 \textcolor{comment}{//  char fn[8+3+1];}
1213 
1214 
1215     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = auto\_mount(&path, 0);
1216     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \{
1217         \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = trace\_path(dj, \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, path, &\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});   \textcolor{comment}{/* Trace the directory path */}
1218         \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \{                     \textcolor{comment}{/* Trace completed */}
1219             \textcolor{keywordflow}{if} (\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}) \{                           \textcolor{comment}{/* It is not the root dir */}
1220                 \textcolor{keywordflow}{if} (\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] & \hyperlink{pff_8h_a3a9db44e978ed6c13b641e092d4cd7d3}{AM\_DIR}) \{  \textcolor{comment}{/* The entry is a directory */}
1221                     dj->\hyperlink{struct_d_i_r_aad779eab97ffc889755c8b483fbf9eb5}{clust} =
1222 \textcolor{preprocessor}{#if \_FAT32}
1223 \textcolor{preprocessor}{}                        ((\hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword})\hyperlink{pff_8h_a398519bb08da6457e62567d1f0b567e3}{LD\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_a0bc29c3f09e1e9c40c414f7d50d7905c}{DIR\_FstClusHI}]) << 16) |
1224 #endif
1225                             \hyperlink{pff_8h_a398519bb08da6457e62567d1f0b567e3}{LD\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_aebe0e913bff75a89d38dbcb04baf5dff}{DIR\_FstClusLO}]);
1226                     dj->\hyperlink{struct_d_i_r_aa7c560f325cb4d59f40dc8cf731b6e22}{sect} = \hyperlink{ff_8c_a7519abb60fe91f6aa1d17f64fbae123a}{clust2sect}(dj->\hyperlink{struct_d_i_r_aad779eab97ffc889755c8b483fbf9eb5}{clust});
1227                     dj->\hyperlink{struct_d_i_r_a7cb92c69ac44a71424d6b8a0c3dac288}{index} = 2;
1228                 \} \textcolor{keywordflow}{else} \{                        \textcolor{comment}{/* The entry is not a directory */}
1229                     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca97da8f98fc2e66d8fa7847f9ebb19b8c}{FR\_NO\_FILE};
1230                 \}
1231             \}
1232             dj->\hyperlink{struct_d_i_r_a588688f55d57bf8a7e8c1d2cf88a3c56}{id} = dj->\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a588688f55d57bf8a7e8c1d2cf88a3c56}{id};
1233         \}
1234     \}
1235 
1236     \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1237 \}
\end{DoxyCode}
\hypertarget{tff_8c_adc2cf56980d149befd982ae97c10ace1}{\index{tff.\-c@{tff.\-c}!f\-\_\-read@{f\-\_\-read}}
\index{f\-\_\-read@{f\-\_\-read}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-read}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-read (
\begin{DoxyParamCaption}
\item[{{\bf F\-I\-L} $\ast$}]{fp, }
\item[{void $\ast$}]{buff, }
\item[{{\bf word}}]{btr, }
\item[{{\bf word} $\ast$}]{br}
\end{DoxyParamCaption}
)}}\label{tff_8c_adc2cf56980d149befd982ae97c10ace1}


Definition at line 916 of file tff.\-c.


\begin{DoxyCode}
922 \{
923 \textcolor{comment}{//  FRESULT res;}
924     \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} sect, remain;
925     \hyperlink{p8_2pinguino_2core_2typedef_8h_abad51e07ab6d26bec9f1f786c8d65bcd}{word} rcnt, cc;
926     \hyperlink{tff_8h_af322b62389c843d5727de4796a09f59c}{CLUST} clust;
927     \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} *rbuff = buff;
928 
929 
930     *br = 0;
931     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = validate(fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}, fp->\hyperlink{struct_f_i_l_a588688f55d57bf8a7e8c1d2cf88a3c56}{id});                  \textcolor{comment}{/* Check validity of the object */}
932     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
933     \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} & \hyperlink{tff_8h_ad3b47fe8126573b17752a9a242b76b9a}{FA\_\_ERROR}) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};   \textcolor{comment}{/* Check error flag */}
934     \textcolor{keywordflow}{if} (!(fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} & \hyperlink{tff_8h_a1f4f3530ff03abbd979b072536e72290}{FA\_READ})) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca897e9f2dd7629a80f48af242d8bc1a3d}{FR\_DENIED};    \textcolor{comment}{/* Check access mode */}
935     remain = fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize} - fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr};
936     \textcolor{keywordflow}{if} (btr > remain) btr = (\hyperlink{p8_2pinguino_2core_2typedef_8h_abad51e07ab6d26bec9f1f786c8d65bcd}{word})remain;           \textcolor{comment}{/* Truncate btr by remaining bytes */}
937 
938     \textcolor{keywordflow}{for} ( ;  btr;                                   \textcolor{comment}{/* Repeat until all data transferred */}
939         rbuff += rcnt, fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} += rcnt, *br += rcnt, btr -= rcnt) \{
940         \textcolor{keywordflow}{if} ((fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} % 512U) == 0) \{               \textcolor{comment}{/* On the sector boundary? */}
941             \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} >= fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_af8143a50ac7be72544022dd46a7013da}{csize}) \{       \textcolor{comment}{/* On the cluster boundary? */}
942                 clust = (fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} == 0) ?           \textcolor{comment}{/* On the top of the file? */}
943                     fp->\hyperlink{struct_f_i_l_a5203f761bacf25758b7e736215f74349}{org\_clust} : get\_cluster(fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust});
944                 \textcolor{keywordflow}{if} (clust < 2 || clust >= fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_aa628566fa0882ed951ed01fc6f20ff1b}{max\_clust}) \textcolor{keywordflow}{goto} fr\_error;
945                 fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust} = clust;               \textcolor{comment}{/* Update current cluster */}
946                 fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} = 0;                     \textcolor{comment}{/* Reset sector address in the cluster */}
947             \}
948             sect = \hyperlink{ff_8c_a7519abb60fe91f6aa1d17f64fbae123a}{clust2sect}(fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust}) + fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect}; \textcolor{comment}{/* Get current sector 
      */}
949             cc = btr / 512U;                        \textcolor{comment}{/* When remaining bytes >= sector size, */}
950             \textcolor{keywordflow}{if} (cc) \{                               \textcolor{comment}{/* Read maximum contiguous sectors directly */}
951                 \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} + cc > fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_af8143a50ac7be72544022dd46a7013da}{csize}) \textcolor{comment}{/* Clip at cluster boundary */}
952                     cc = fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_af8143a50ac7be72544022dd46a7013da}{csize} - fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect};
953                 \textcolor{keywordflow}{if} (\hyperlink{p8_2pinguino_2libraries_2sd_2diskio_8h_a77ba19c0c97a900fac95999446e32308}{disk\_read}(rbuff, sect, (\hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte})cc) != \hyperlink{p8_2pinguino_2libraries_2sd_2diskio_8h_aacdfef1dad6565f65c26d12fe0ea4b2ba2ea4b6ef3fffc17dd1d38ab5c2837737}{RES\_OK})
954                     \textcolor{keywordflow}{goto} fr\_error;
955                 fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} += (\hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte})cc;             \textcolor{comment}{/* Next sector address in the cluster */}
956                 rcnt = 512U * cc;                   \textcolor{comment}{/* Number of bytes transferred */}
957                 \textcolor{keywordflow}{continue};
958             \}
959             fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect}++;                           \textcolor{comment}{/* Next sector address in the cluster */}
960         \}
961         sect = \hyperlink{ff_8c_a7519abb60fe91f6aa1d17f64fbae123a}{clust2sect}(fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust}) + fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} - 1; \textcolor{comment}{/* Get current sector 
      */}
962         \textcolor{keywordflow}{if} (!move\_window(sect)) \textcolor{keywordflow}{goto} fr\_error;      \textcolor{comment}{/* Move sector window */}
963         rcnt = 512U - (fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} % 512U);            \textcolor{comment}{/* Get partial sector from sector window */}
964         \textcolor{keywordflow}{if} (rcnt > btr) rcnt = btr;
965         memcpy(rbuff, &fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a54541860d8273ee2709def80ccc3e271}{win}[fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} % 512U], rcnt);
966     \}
967 
968     \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK};
969 
970 fr\_error:   \textcolor{comment}{/* Abort this file due to an unrecoverable error */}
971     fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} |= \hyperlink{tff_8h_ad3b47fe8126573b17752a9a242b76b9a}{FA\_\_ERROR};
972     \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
973 \}
\end{DoxyCode}
\hypertarget{tff_8c_a7fb1cd8728766e81e10339307e68a795}{\index{tff.\-c@{tff.\-c}!f\-\_\-readdir@{f\-\_\-readdir}}
\index{f\-\_\-readdir@{f\-\_\-readdir}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-readdir}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-readdir (
\begin{DoxyParamCaption}
\item[{{\bf D\-I\-R} $\ast$}]{dj, }
\item[{{\bf F\-I\-L\-I\-N\-F\-O} $\ast$}]{finfo}
\end{DoxyParamCaption}
)}}\label{tff_8c_a7fb1cd8728766e81e10339307e68a795}


Definition at line 1246 of file tff.\-c.



Referenced by list\-Dir(), and scan\-\_\-files().


\begin{DoxyCode}
1250 \{
1251 \textcolor{comment}{//  FRESULT res;}
1252 \textcolor{comment}{//  byte *dir;}
1253     \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} \hyperlink{p8_2pinguino_2libraries_2_p_c_d8544_8c_aa0dd25f53b00986c159fb20de6894e51}{c};
1254 
1255 
1256     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = validate(dj->\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}, dj->\hyperlink{struct_d_i_r_a588688f55d57bf8a7e8c1d2cf88a3c56}{id});          \textcolor{comment}{/* Check validity of the object */}
1257     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1258 
1259     finfo->\hyperlink{struct_f_i_l_i_n_f_o_a5a78da1cb66644bf00efc71578d7fbba}{fname}[0] = 0;
1260     \textcolor{keywordflow}{while} (dj->\hyperlink{struct_d_i_r_aa7c560f325cb4d59f40dc8cf731b6e22}{sect}) \{
1261         \textcolor{keywordflow}{if} (!move\_window(dj->\hyperlink{struct_d_i_r_aa7c560f325cb4d59f40dc8cf731b6e22}{sect}))
1262             \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1263         \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir} = &dj->\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a54541860d8273ee2709def80ccc3e271}{win}[(dj->\hyperlink{struct_d_i_r_a7cb92c69ac44a71424d6b8a0c3dac288}{index} & 15) * 32]; \textcolor{comment}{/* pointer to the directory entry */}
1264         c = \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_afa89348e9fc2de82ae9e12c661366b0e}{DIR\_Name}];
1265         \textcolor{keywordflow}{if} (c == 0) \textcolor{keywordflow}{break};                          \textcolor{comment}{/* Has it reached to end of dir? */}
1266         \textcolor{keywordflow}{if} (c != 0xE5 && !(\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] & \hyperlink{pff_8h_a5cfae62dabae0a54809e43b36685ce7c}{AM\_VOL}))    \textcolor{comment}{/* Is it a valid entry? */}
1267             get\_fileinfo(finfo, \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});
1268         \textcolor{keywordflow}{if} (!next\_dir\_entry(dj)) dj->\hyperlink{struct_d_i_r_aa7c560f325cb4d59f40dc8cf731b6e22}{sect} = 0;      \textcolor{comment}{/* Next entry */}
1269         \hyperlink{p8_2pinguino_2libraries_2_p_c_d8544_8c_af84ca11bf86c56a1f74027a99d48218d}{if} (finfo->\hyperlink{struct_f_i_l_i_n_f_o_a5a78da1cb66644bf00efc71578d7fbba}{fname}[0]) \textcolor{keywordflow}{break};                  \textcolor{comment}{/* Found valid entry */}
1270     \}
1271 
1272     \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK};
1273 \}
\end{DoxyCode}
\hypertarget{tff_8c_af87378f8760b74f1f13bc2b2f9eab7fa}{\index{tff.\-c@{tff.\-c}!f\-\_\-rename@{f\-\_\-rename}}
\index{f\-\_\-rename@{f\-\_\-rename}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-rename}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-rename (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{path\-\_\-old, }
\item[{const char $\ast$}]{path\-\_\-new}
\end{DoxyParamCaption}
)}}\label{tff_8c_af87378f8760b74f1f13bc2b2f9eab7fa}


Definition at line 1619 of file tff.\-c.


\begin{DoxyCode}
1623 \{
1624     \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44c}{FRESULT} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1625     \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} sect\_old;
1626     \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} *dir\_old, *dir\_new, direntry[32-11];
1627 \textcolor{comment}{//  DIR dj;}
1628 \textcolor{comment}{//  char fn[8+3+1];}
1629 
1630 
1631     res = auto\_mount(&path\_old, 1);
1632     \textcolor{keywordflow}{if} (res != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1633 
1634     res = trace\_path(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, path\_old, &dir\_old);  \textcolor{comment}{/* Check old object */}
1635     \textcolor{keywordflow}{if} (res != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};               \textcolor{comment}{/* The old object is not found */}
1636     \textcolor{keywordflow}{if} (!dir\_old) \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca97da8f98fc2e66d8fa7847f9ebb19b8c}{FR\_NO\_FILE};
1637     sect\_old = \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a5ee19a26d1dfd79d52fbba59cc792da3}{winsect};                   \textcolor{comment}{/* Save the object information */}
1638     memcpy(direntry, &dir\_old[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}], 32-11);
1639 
1640     res = trace\_path(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, path\_new, &dir\_new);  \textcolor{comment}{/* Check new object */}
1641     \textcolor{keywordflow}{if} (res == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca0d8f024d256df76e84782b95018a2450}{FR\_EXIST};         \textcolor{comment}{/* The new object name is already existing */}
1642     \textcolor{keywordflow}{if} (res != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca97da8f98fc2e66d8fa7847f9ebb19b8c}{FR\_NO\_FILE}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};         \textcolor{comment}{/* Is there no old name? */}
1643     res = reserve\_direntry(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, &dir\_new);        \textcolor{comment}{/* Reserve a directory entry */}
1644     \textcolor{keywordflow}{if} (res != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1645 
1646     memcpy(&dir\_new[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}], direntry, 32-11);    \textcolor{comment}{/* Create new entry */}
1647     memcpy(&dir\_new[\hyperlink{pff_8h_afa89348e9fc2de82ae9e12c661366b0e}{DIR\_Name}], \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, 8+3);
1648     dir\_new[\hyperlink{pff_8h_a87ee1f701c2ab941862e3ce00c1c1e9d}{DIR\_NTres}] = \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}[11];
1649     \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_ac310e0b372e8ec4195568846746d2f49}{winflag} = 1;
1650 
1651     \textcolor{keywordflow}{if} (!move\_window(sect\_old)) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};  \textcolor{comment}{/* Delete old entry */}
1652     dir\_old[\hyperlink{pff_8h_afa89348e9fc2de82ae9e12c661366b0e}{DIR\_Name}] = 0xE5;
1653 
1654     \textcolor{keywordflow}{return} sync();
1655 \}
\end{DoxyCode}
\hypertarget{tff_8c_a26682b1b1f065f5d83b64713abdb0c45}{\index{tff.\-c@{tff.\-c}!f\-\_\-stat@{f\-\_\-stat}}
\index{f\-\_\-stat@{f\-\_\-stat}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-stat}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-stat (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{path, }
\item[{{\bf F\-I\-L\-I\-N\-F\-O} $\ast$}]{finfo}
\end{DoxyParamCaption}
)}}\label{tff_8c_a26682b1b1f065f5d83b64713abdb0c45}


Definition at line 1283 of file tff.\-c.


\begin{DoxyCode}
1287 \{
1288 \textcolor{comment}{//  FRESULT res;}
1289 \textcolor{comment}{//  DIR dj;}
1290 \textcolor{comment}{//  byte *dir;}
1291 \textcolor{comment}{//  char fn[8+3+1];}
1292 
1293 
1294     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = auto\_mount(&path, 0);
1295     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \{
1296         \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = trace\_path(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, path, &\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});    \textcolor{comment}{/* Trace the file path */}
1297         \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \{                     \textcolor{comment}{/* Trace completed */}
1298             \textcolor{keywordflow}{if} (\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}) \textcolor{comment}{/* Found an object */}
1299                 get\_fileinfo(finfo, \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});
1300             \textcolor{keywordflow}{else}        \textcolor{comment}{/* It is root dir */}
1301                 \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca83e45a4b579558c57192c0a391b9bb45}{FR\_INVALID\_NAME};
1302         \}
1303     \}
1304 
1305     \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1306 \}
\end{DoxyCode}
\hypertarget{tff_8c_ad69c7246b122ba56a134939ee0eaf847}{\index{tff.\-c@{tff.\-c}!f\-\_\-sync@{f\-\_\-sync}}
\index{f\-\_\-sync@{f\-\_\-sync}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-sync}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-sync (
\begin{DoxyParamCaption}
\item[{{\bf F\-I\-L} $\ast$}]{fp}
\end{DoxyParamCaption}
)}}\label{tff_8c_ad69c7246b122ba56a134939ee0eaf847}


Definition at line 1061 of file tff.\-c.



Referenced by f\-\_\-close().


\begin{DoxyCode}
1064 \{
1065 \textcolor{comment}{//  FRESULT res;}
1066     \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} tim;
1067 \textcolor{comment}{//  byte *dir;}
1068 
1069     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = validate(fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}, fp->\hyperlink{struct_f_i_l_a588688f55d57bf8a7e8c1d2cf88a3c56}{id});      \textcolor{comment}{/* Check validity of the object */}
1070     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \{
1071         \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} & \hyperlink{tff_8h_ac4b7d5223f84df91c306ffbff536fae4}{FA\_\_WRITTEN}) \{    \textcolor{comment}{/* Has the file been written? */}
1072             \textcolor{comment}{/* Update the directory entry */}
1073             \textcolor{keywordflow}{if} (!move\_window(fp->\hyperlink{struct_f_i_l_ac40d4a51f8f940e6154d364c45935278}{dir\_sect})) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1074             \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir} = fp->\hyperlink{struct_f_i_l_abc0a41dfbb69ffc78a01f5a357412995}{dir\_ptr};
1075             \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] |= \hyperlink{pff_8h_ae8174d00798e34e7c9e95898cb9e1a09}{AM\_ARC};                       \textcolor{comment}{/* Set archive bit */}
1076             \hyperlink{pff_8h_abf5aba973d95ac5843b80aa7379cdd66}{ST\_DWORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_abfbfa613864a02a65f0bf70ead6672c7}{DIR\_FileSize}], fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize});        \textcolor{comment}{/* Update file size
       */}
1077             \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_aebe0e913bff75a89d38dbcb04baf5dff}{DIR\_FstClusLO}], fp->\hyperlink{struct_f_i_l_a5203f761bacf25758b7e736215f74349}{org\_clust});    \textcolor{comment}{/* Update start
       cluster */}
1078 \textcolor{preprocessor}{#if \_FAT32}
1079 \textcolor{preprocessor}{}            \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_a0bc29c3f09e1e9c40c414f7d50d7905c}{DIR\_FstClusHI}], fp->\hyperlink{struct_f_i_l_a5203f761bacf25758b7e736215f74349}{org\_clust} >> 16);
1080 \textcolor{preprocessor}{#endif}
1081 \textcolor{preprocessor}{}            tim = \hyperlink{tff_8h_a489f23a9be58cd896a5c45e45c6e6e6f}{get\_fattime}();                 \textcolor{comment}{/* Updated time */}
1082             \hyperlink{pff_8h_abf5aba973d95ac5843b80aa7379cdd66}{ST\_DWORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ab9452d336adeece2a1b0b54ab35b8a59}{DIR\_WrtTime}], tim);
1083             fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} &= (\hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte})~\hyperlink{tff_8h_ac4b7d5223f84df91c306ffbff536fae4}{FA\_\_WRITTEN};
1084             \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = sync();
1085         \}
1086     \}
1087     \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1088 \}
\end{DoxyCode}
\hypertarget{tff_8c_a691a27b40c348f7c84b42e911636f38a}{\index{tff.\-c@{tff.\-c}!f\-\_\-truncate@{f\-\_\-truncate}}
\index{f\-\_\-truncate@{f\-\_\-truncate}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-truncate}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-truncate (
\begin{DoxyParamCaption}
\item[{{\bf F\-I\-L} $\ast$}]{fp}
\end{DoxyParamCaption}
)}}\label{tff_8c_a691a27b40c348f7c84b42e911636f38a}


Definition at line 1316 of file tff.\-c.


\begin{DoxyCode}
1319 \{
1320 \textcolor{comment}{//  FRESULT res;}
1321     \hyperlink{tff_8h_af322b62389c843d5727de4796a09f59c}{CLUST} ncl;
1322 
1323 
1324     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = validate(fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}, fp->\hyperlink{struct_f_i_l_a588688f55d57bf8a7e8c1d2cf88a3c56}{id});      \textcolor{comment}{/* Check validity of the object */}
1325     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1326     \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} & \hyperlink{tff_8h_ad3b47fe8126573b17752a9a242b76b9a}{FA\_\_ERROR}) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};   \textcolor{comment}{/* Check error flag */}
1327     \textcolor{keywordflow}{if} (!(fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} & \hyperlink{tff_8h_afa366963220c89b882c0361794020c14}{FA\_WRITE})) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca897e9f2dd7629a80f48af242d8bc1a3d}{FR\_DENIED};  \textcolor{comment}{/* Check access mode */}
1328 
1329     \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize} > fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr}) \{
1330         fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize} = fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr};  \textcolor{comment}{/* Set file size to current R/W point */}
1331         fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} |= \hyperlink{tff_8h_ac4b7d5223f84df91c306ffbff536fae4}{FA\_\_WRITTEN};
1332         \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} == 0) \{    \textcolor{comment}{/* When set file size to zero, remove entire cluster chain */}
1333             \textcolor{keywordflow}{if} (!remove\_chain(fp->\hyperlink{struct_f_i_l_a5203f761bacf25758b7e736215f74349}{org\_clust})) \textcolor{keywordflow}{goto} ft\_error;
1334             fp->\hyperlink{struct_f_i_l_a5203f761bacf25758b7e736215f74349}{org\_clust} = 0;
1335         \} \textcolor{keywordflow}{else} \{                \textcolor{comment}{/* When truncate a part of the file, remove remaining clusters */}
1336             ncl = get\_cluster(fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust});
1337             \textcolor{keywordflow}{if} (ncl < 2) \textcolor{keywordflow}{goto} ft\_error;
1338             \textcolor{keywordflow}{if} (ncl < fp->fs->max\_clust) \{
1339                 \textcolor{keywordflow}{if} (!put\_cluster(fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust}, (\hyperlink{tff_8h_af322b62389c843d5727de4796a09f59c}{CLUST})0x0FFFFFFF)) \textcolor{keywordflow}{goto} ft\_error;
1340                 \textcolor{keywordflow}{if} (!remove\_chain(ncl)) \textcolor{keywordflow}{goto} ft\_error;
1341             \}
1342         \}
1343     \}
1344 
1345     \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK};
1346 
1347 ft\_error:   \textcolor{comment}{/* Abort this file due to an unrecoverable error */}
1348     fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} |= \hyperlink{tff_8h_ad3b47fe8126573b17752a9a242b76b9a}{FA\_\_ERROR};
1349     \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1350 \}
\end{DoxyCode}
\hypertarget{tff_8c_a8b0dc705b1e4820bee93ec58753f7368}{\index{tff.\-c@{tff.\-c}!f\-\_\-unlink@{f\-\_\-unlink}}
\index{f\-\_\-unlink@{f\-\_\-unlink}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-unlink}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-unlink (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{path}
\end{DoxyParamCaption}
)}}\label{tff_8c_a8b0dc705b1e4820bee93ec58753f7368}


Definition at line 1425 of file tff.\-c.


\begin{DoxyCode}
1428 \{
1429 \textcolor{comment}{//  FRESULT res;}
1430 \textcolor{comment}{//  DIR dj;}
1431 \textcolor{comment}{//  byte *dir;}
1432     \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} *sdir;
1433     \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} dsect;
1434 \textcolor{comment}{//  char fn[8+3+1];}
1435     \hyperlink{tff_8h_af322b62389c843d5727de4796a09f59c}{CLUST} dclust;
1436 
1437 
1438     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = auto\_mount(&path, 1);
1439     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1440     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = trace\_path(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, path, &\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});    \textcolor{comment}{/* Trace the file path */}
1441     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};            \textcolor{comment}{/* Trace failed */}
1442     \textcolor{keywordflow}{if} (!\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca83e45a4b579558c57192c0a391b9bb45}{FR\_INVALID\_NAME};     \textcolor{comment}{/* It is the root directory */}
1443     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] & \hyperlink{pff_8h_add6d85d1e7a02b4f6188783ef91a5f1e}{AM\_RDO}) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca897e9f2dd7629a80f48af242d8bc1a3d}{FR\_DENIED}; \textcolor{comment}{/* It is a R/O object */}
1444     dsect = \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a5ee19a26d1dfd79d52fbba59cc792da3}{winsect};
1445     dclust =
1446 \textcolor{preprocessor}{#if \_FAT32}
1447 \textcolor{preprocessor}{}        ((\hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword})\hyperlink{pff_8h_a398519bb08da6457e62567d1f0b567e3}{LD\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_a0bc29c3f09e1e9c40c414f7d50d7905c}{DIR\_FstClusHI}]) << 16) |
1448 #endif
1449         \hyperlink{pff_8h_a398519bb08da6457e62567d1f0b567e3}{LD\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_aebe0e913bff75a89d38dbcb04baf5dff}{DIR\_FstClusLO}]);
1450     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] & \hyperlink{pff_8h_a3a9db44e978ed6c13b641e092d4cd7d3}{AM\_DIR}) \{          \textcolor{comment}{/* It is a sub-directory */}
1451         \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_aad779eab97ffc889755c8b483fbf9eb5}{clust} = dclust;                   \textcolor{comment}{/* Check if the sub-dir is empty or not */}
1452         \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_aa7c560f325cb4d59f40dc8cf731b6e22}{sect} = \hyperlink{ff_8c_a7519abb60fe91f6aa1d17f64fbae123a}{clust2sect}(dclust);
1453         \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a7cb92c69ac44a71424d6b8a0c3dac288}{index} = 2;
1454         \textcolor{keywordflow}{do} \{
1455             \textcolor{keywordflow}{if} (!move\_window(\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_aa7c560f325cb4d59f40dc8cf731b6e22}{sect})) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1456             sdir = &\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a54541860d8273ee2709def80ccc3e271}{win}[(\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a7cb92c69ac44a71424d6b8a0c3dac288}{index} & 15) * 32];
1457             \textcolor{keywordflow}{if} (sdir[\hyperlink{pff_8h_afa89348e9fc2de82ae9e12c661366b0e}{DIR\_Name}] == 0) \textcolor{keywordflow}{break};
1458             \textcolor{keywordflow}{if} (sdir[\hyperlink{pff_8h_afa89348e9fc2de82ae9e12c661366b0e}{DIR\_Name}] != 0xE5 && !(sdir[\hyperlink{pff_8h_ad3233e40118ed66095f3c9545b788f8a}{DIR\_Attr}] & 
      \hyperlink{pff_8h_a5cfae62dabae0a54809e43b36685ce7c}{AM\_VOL}))
1459                 \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca897e9f2dd7629a80f48af242d8bc1a3d}{FR\_DENIED};  \textcolor{comment}{/* The directory is not empty */}
1460         \} \textcolor{keywordflow}{while} (next\_dir\_entry(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}));
1461     \}
1462 
1463     \textcolor{keywordflow}{if} (!move\_window(dsect)) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR}; \textcolor{comment}{/* Mark the directory entry 'deleted' */}
1464     \hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_afa89348e9fc2de82ae9e12c661366b0e}{DIR\_Name}] = 0xE5;
1465     \hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}.\hyperlink{struct_d_i_r_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_ac310e0b372e8ec4195568846746d2f49}{winflag} = 1;
1466     \textcolor{keywordflow}{if} (!remove\_chain(dclust)) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};   \textcolor{comment}{/* Remove the cluster chain */}
1467 
1468     \textcolor{keywordflow}{return} sync();
1469 \}
\end{DoxyCode}
\hypertarget{tff_8c_a76c226618f3d211d722ab9db801d216d}{\index{tff.\-c@{tff.\-c}!f\-\_\-utime@{f\-\_\-utime}}
\index{f\-\_\-utime@{f\-\_\-utime}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-utime}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-utime (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{path, }
\item[{const {\bf F\-I\-L\-I\-N\-F\-O} $\ast$}]{finfo}
\end{DoxyParamCaption}
)}}\label{tff_8c_a76c226618f3d211d722ab9db801d216d}


Definition at line 1585 of file tff.\-c.


\begin{DoxyCode}
1589 \{
1590 \textcolor{comment}{//  FRESULT res;}
1591 \textcolor{comment}{//  DIR dj;}
1592 \textcolor{comment}{//  byte *dir;}
1593 \textcolor{comment}{//  char fn[8+3+1];}
1594 
1595 
1596     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = auto\_mount(&path, 1);
1597     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \{
1598         \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = trace\_path(&\hyperlink{tff_8c_a90affc32512431e143844fa9721bf9d9}{dj}, \hyperlink{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{fn}, path, &\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir});    \textcolor{comment}{/* Trace the file path */}
1599         \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} == \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \{             \textcolor{comment}{/* Trace completed */}
1600             \textcolor{keywordflow}{if} (!\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}) \{
1601                 \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca83e45a4b579558c57192c0a391b9bb45}{FR\_INVALID\_NAME};    \textcolor{comment}{/* Root directory */}
1602             \} \textcolor{keywordflow}{else} \{
1603                 \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_ab9452d336adeece2a1b0b54ab35b8a59}{DIR\_WrtTime}], finfo->\hyperlink{struct_f_i_l_i_n_f_o_a3f6ad56d9c47d7ca879332e034917077}{ftime});
1604                 \hyperlink{pff_8h_a95ceb4c25b216e71baa7102939edfd0d}{ST\_WORD}(&\hyperlink{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{dir}[\hyperlink{pff_8h_abed17fa699511b09cbf64961373d63a4}{DIR\_WrtDate}], finfo->\hyperlink{struct_f_i_l_i_n_f_o_a9478c5225c4f3a09d739dbc2245a72fd}{fdate});
1605                 \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = sync();
1606             \}
1607         \}
1608     \}
1609     \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1610 \}
\end{DoxyCode}
\hypertarget{tff_8c_afe68f25170c6ab23400131b42bb34cf2}{\index{tff.\-c@{tff.\-c}!f\-\_\-write@{f\-\_\-write}}
\index{f\-\_\-write@{f\-\_\-write}!tff.c@{tff.\-c}}
\subsubsection[{f\-\_\-write}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} f\-\_\-write (
\begin{DoxyParamCaption}
\item[{{\bf F\-I\-L} $\ast$}]{fp, }
\item[{const void $\ast$}]{buff, }
\item[{{\bf word}}]{btw, }
\item[{{\bf word} $\ast$}]{bw}
\end{DoxyParamCaption}
)}}\label{tff_8c_afe68f25170c6ab23400131b42bb34cf2}


Definition at line 983 of file tff.\-c.


\begin{DoxyCode}
989 \{
990 \textcolor{comment}{//  FRESULT res;}
991     \hyperlink{p8_2pinguino_2core_2typedef_8h_a74cb93d430006e784da73b8ca406ee6e}{dword} sect;
992     \hyperlink{p8_2pinguino_2core_2typedef_8h_abad51e07ab6d26bec9f1f786c8d65bcd}{word} wcnt, cc;
993     \hyperlink{tff_8h_af322b62389c843d5727de4796a09f59c}{CLUST} clust;
994     \textcolor{keyword}{const} \hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte} *wbuff = buff;
995 
996 
997     *bw = 0;
998     \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} = validate(fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}, fp->\hyperlink{struct_f_i_l_a588688f55d57bf8a7e8c1d2cf88a3c56}{id});                  \textcolor{comment}{/* Check validity of the object */}
999     \textcolor{keywordflow}{if} (\hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res} != \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK}) \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1000     \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} & \hyperlink{tff_8h_ad3b47fe8126573b17752a9a242b76b9a}{FA\_\_ERROR}) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};   \textcolor{comment}{/* Check error flag */}
1001     \textcolor{keywordflow}{if} (!(fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} & \hyperlink{tff_8h_afa366963220c89b882c0361794020c14}{FA\_WRITE})) \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca897e9f2dd7629a80f48af242d8bc1a3d}{FR\_DENIED};  \textcolor{comment}{/* Check access mode */}
1002     \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize} + btw < fp->\hyperlink{itdb02__graph_8h_aa5154f1f2f741b1408f8726078a53e27}{fsize}) \textcolor{keywordflow}{return} \hyperlink{pff_8h_a49d0171ecbd362cda5680a0d360db44ca62fce5cd9df008f8fc85f99706bda5f1}{FR\_OK};   \textcolor{comment}{/* File size cannot reach 4GB */}
1003 
1004     \textcolor{keywordflow}{for} ( ;  btw;                                   \textcolor{comment}{/* Repeat until all data transferred */}
1005         wbuff += wcnt, fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} += wcnt, *bw += wcnt, btw -= wcnt) \{
1006         \textcolor{keywordflow}{if} ((fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} % 512U) == 0) \{               \textcolor{comment}{/* On the sector boundary? */}
1007             \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} >= fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_af8143a50ac7be72544022dd46a7013da}{csize}) \{       \textcolor{comment}{/* On the cluster boundary? */}
1008                 \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} == 0) \{                \textcolor{comment}{/* On the top of the file? */}
1009                     clust = fp->\hyperlink{struct_f_i_l_a5203f761bacf25758b7e736215f74349}{org\_clust};         \textcolor{comment}{/* Follow from the origin */}
1010                     \textcolor{keywordflow}{if} (clust == 0)                 \textcolor{comment}{/* When there is no cluster chain, */}
1011                         fp->\hyperlink{struct_f_i_l_a5203f761bacf25758b7e736215f74349}{org\_clust} = clust = create\_chain(0);   \textcolor{comment}{/* Create a new cluster chain 
      */}
1012                 \} \textcolor{keywordflow}{else} \{                            \textcolor{comment}{/* Middle or end of the file */}
1013                     clust = create\_chain(fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust});         \textcolor{comment}{/* Trace or streach cluster
       chain */}
1014                 \}
1015                 \textcolor{keywordflow}{if} (clust == 0) \textcolor{keywordflow}{break};              \textcolor{comment}{/* Could not allocate a new cluster (disk full) */}
1016                 \textcolor{keywordflow}{if} (clust == 1 || clust >= fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_aa628566fa0882ed951ed01fc6f20ff1b}{max\_clust}) \textcolor{keywordflow}{goto} fw\_error;
1017                 fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust} = clust;               \textcolor{comment}{/* Update current cluster */}
1018                 fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} = 0;                     \textcolor{comment}{/* Reset sector address in the cluster */}
1019             \}
1020             sect = \hyperlink{ff_8c_a7519abb60fe91f6aa1d17f64fbae123a}{clust2sect}(fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust}) + fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect}; \textcolor{comment}{/* Get current sector 
      */}
1021             cc = btw / 512U;                        \textcolor{comment}{/* When remaining bytes >= sector size, */}
1022             \textcolor{keywordflow}{if} (cc) \{                               \textcolor{comment}{/* Write maximum contiguous sectors directly */}
1023                 \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} + cc > fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_af8143a50ac7be72544022dd46a7013da}{csize}) \textcolor{comment}{/* Clip at cluster boundary */}
1024                     cc = fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_af8143a50ac7be72544022dd46a7013da}{csize} - fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect};
1025                 \textcolor{keywordflow}{if} (\hyperlink{p8_2pinguino_2libraries_2sd_2diskio_8h_a7ffe0ccc946550a260d00871c6b636e7}{disk\_write}(wbuff, sect, (\hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte})cc) != \hyperlink{p8_2pinguino_2libraries_2sd_2diskio_8h_aacdfef1dad6565f65c26d12fe0ea4b2ba2ea4b6ef3fffc17dd1d38ab5c2837737}{RES\_OK})
1026                     \textcolor{keywordflow}{goto} fw\_error;
1027                 fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} += (\hyperlink{p8_2pinguino_2core_2typedef_8h_a0c8186d9b9b7880309c27230bbb5e69d}{byte})cc;             \textcolor{comment}{/* Next sector address in the cluster */}
1028                 wcnt = 512U * cc;                   \textcolor{comment}{/* Number of bytes transferred */}
1029                 \textcolor{keywordflow}{continue};
1030             \}
1031             \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} >= fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize}) \{           \textcolor{comment}{/* Flush R/W window without reading if needed 
      */}
1032                 \textcolor{keywordflow}{if} (!move\_window(0)) \textcolor{keywordflow}{goto} fw\_error;
1033                 fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a5ee19a26d1dfd79d52fbba59cc792da3}{winsect} = sect;
1034             \}
1035             fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect}++;                           \textcolor{comment}{/* Next sector address in the cluster */}
1036         \}
1037         sect = \hyperlink{ff_8c_a7519abb60fe91f6aa1d17f64fbae123a}{clust2sect}(fp->\hyperlink{struct_f_i_l_a32da77ccc2ccbe19278c7889417fb9a3}{curr\_clust}) + fp->\hyperlink{struct_f_i_l_ae338a94c0232319659d442df5676325d}{csect} - 1; \textcolor{comment}{/* Get current sector 
      */}
1038         \textcolor{keywordflow}{if} (!move\_window(sect)) \textcolor{keywordflow}{goto} fw\_error;      \textcolor{comment}{/* Move sector window */}
1039         wcnt = 512U - (fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} % 512U);            \textcolor{comment}{/* Put partial sector into sector window */}
1040         \textcolor{keywordflow}{if} (wcnt > btw) wcnt = btw;
1041         memcpy(&fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_a54541860d8273ee2709def80ccc3e271}{win}[fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} % 512U], wbuff, wcnt);
1042         fp->\hyperlink{struct_f_i_l_a472e3612956e3ffb3ab823c37ca33250}{fs}->\hyperlink{struct_f_a_t_f_s_ac310e0b372e8ec4195568846746d2f49}{winflag} = 1;
1043     \}
1044 
1045     \textcolor{keywordflow}{if} (fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr} > fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize}) \{fp->\hyperlink{struct_f_i_l_a7582a0b3a658c0543f6cdc7585d84f7c}{fsize} = fp->\hyperlink{struct_f_i_l_a5afdaf3451d484cc97e07228b775ccf1}{fptr};\} \textcolor{comment}{/* Update file size if needed */}
1046     fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} |= \hyperlink{tff_8h_ac4b7d5223f84df91c306ffbff536fae4}{FA\_\_WRITTEN};                     \textcolor{comment}{/* Set file changed flag */}
1047     \textcolor{keywordflow}{return} \hyperlink{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{res};
1048 
1049 fw\_error:   \textcolor{comment}{/* Abort this file due to an unrecoverable error */}
1050     fp->\hyperlink{struct_f_i_l_ae84669505a47c55d6246560a290a298d}{flag} |= \hyperlink{tff_8h_ad3b47fe8126573b17752a9a242b76b9a}{FA\_\_ERROR};
1051     \textcolor{keywordflow}{return} \hyperlink{tff_8h_a49d0171ecbd362cda5680a0d360db44ca40dbd5f7138201bd676f4b19c11e93f4}{FR\_RW\_ERROR};
1052 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{tff_8c_addeee88e846cc637a785bcaf23b45b5e}{\index{tff.\-c@{tff.\-c}!dir@{dir}}
\index{dir@{dir}!tff.c@{tff.\-c}}
\subsubsection[{dir}]{\setlength{\rightskip}{0pt plus 5cm}{\bf byte}$\ast$ dir}}\label{tff_8c_addeee88e846cc637a785bcaf23b45b5e}


Definition at line 68 of file tff.\-c.



Referenced by f\-\_\-chmod(), f\-\_\-mkdir(), f\-\_\-open(), f\-\_\-rename(), f\-\_\-sync(), f\-\_\-unlink(), f\-\_\-utime(), list\-Dir(), pf\-\_\-open(), and scan\-\_\-files().

\hypertarget{tff_8c_a90affc32512431e143844fa9721bf9d9}{\index{tff.\-c@{tff.\-c}!dj@{dj}}
\index{dj@{dj}!tff.c@{tff.\-c}}
\subsubsection[{dj}]{\setlength{\rightskip}{0pt plus 5cm}{\bf D\-I\-R} dj}}\label{tff_8c_a90affc32512431e143844fa9721bf9d9}


Definition at line 66 of file tff.\-c.



Referenced by f\-\_\-chmod(), f\-\_\-mkdir(), f\-\_\-open(), f\-\_\-stat(), f\-\_\-unlink(), f\-\_\-utime(), and pf\-\_\-open().

\hypertarget{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}{\index{tff.\-c@{tff.\-c}!fn@{fn}}
\index{fn@{fn}!tff.c@{tff.\-c}}
\subsubsection[{fn}]{\setlength{\rightskip}{0pt plus 5cm}char fn\mbox{[}12\mbox{]}}}\label{tff_8c_a4eeeb71a8aa4cf022612fc51ab25ed15}


Definition at line 67 of file tff.\-c.



Referenced by scan\-\_\-files().

\hypertarget{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}{\index{tff.\-c@{tff.\-c}!res@{res}}
\index{res@{res}!tff.c@{tff.\-c}}
\subsubsection[{res}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\-R\-E\-S\-U\-L\-T} res}}\label{tff_8c_aab43d7bcfb87e7ef71138d651ce1bea1}


Definition at line 65 of file tff.\-c.



Referenced by disk\-\_\-ioctl(), D\-S18\-B20\-Read(), D\-S18\-B20\-Read\-Measure(), D\-S18\-B20\-Start\-Measure(), f\-\_\-chmod(), f\-\_\-close(), f\-\_\-getfree(), f\-\_\-lseek(), f\-\_\-mkdir(), f\-\_\-open(), f\-\_\-opendir(), f\-\_\-read(), f\-\_\-readdir(), f\-\_\-rename(), f\-\_\-stat(), f\-\_\-sync(), f\-\_\-truncate(), f\-\_\-unlink(), f\-\_\-utime(), f\-\_\-write(), list\-Dir(), pf\-\_\-open(), powi(), put\-\_\-fat(), scan\-\_\-files(), and sd\-\_\-status().

