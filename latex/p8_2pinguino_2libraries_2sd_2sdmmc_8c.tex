\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c}{\section{/dvpt/pinguino/git/pinguino-\/libraries/p8/pinguino/libraries/sd/sdmmc.c File Reference}
\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c}\index{/dvpt/pinguino/git/pinguino-\/libraries/p8/pinguino/libraries/sd/sdmmc.\-c@{/dvpt/pinguino/git/pinguino-\/libraries/p8/pinguino/libraries/sd/sdmmc.\-c}}
}
{\ttfamily \#include $<$system.\-c$>$}\\*
{\ttfamily \#include $<$digitalw.\-c$>$}\\*
{\ttfamily \#include $<$pin.\-h$>$}\\*
{\ttfamily \#include $<$sd/sdmmc.\-h$>$}\\*
{\ttfamily \#include $<$sd/fileio.\-h$>$}\\*
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a5cc0f45eb89249d1ed7720e04a5a0130}{\-\_\-\-\_\-\-S\-D\-M\-M\-C\-\_\-\-C\-\_\-\-\_\-}
\item 
\#define \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ad7b4058b669998a3ca854c28167aa0a0}{read\-S\-P\-I}()~\hyperlink{p32_2include_2pinguino_2libraries_2sd_2sdmmc_8h_a39a07566d7d6294bb14c9069983c36ed}{write\-S\-P\-I}(0x\-F\-F)
\item 
\#define \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ab71fa577a8bc96bd643f084e22eed47b}{clock\-S\-P\-I}()~\hyperlink{p32_2include_2pinguino_2libraries_2sd_2sdmmc_8h_a39a07566d7d6294bb14c9069983c36ed}{write\-S\-P\-I}(0x\-F\-F)
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
unsigned char \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}{write\-S\-P\-I} (unsigned char b)
\item 
void \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a469e8fffcf5a77dc542d8acea1cfea57}{init\-S\-D} (void)
\item 
void \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a1531d2f76a265f4def4044d9c028c1a5}{disable\-S\-D} (void)
\item 
void \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aea80f1bdf2c4aba640129a965f4e071f}{enable\-S\-D} (void)
\item 
int \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_af35781ed6bb5671aa7cf321e48ed0009}{send\-S\-D\-Cmd} (unsigned char \hyperlink{p32_2include_2pinguino_2libraries_2_p_c_d8544_8c_aa0dd25f53b00986c159fb20de6894e51}{c}, unsigned a)
\item 
int \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a0a62982cc6fc4507eacea6f73767da72}{init\-Media} (void)
\item 
int \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aa852b20c06fce185a342322012a3b01e}{read\-S\-E\-C\-T\-O\-R} (\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_ae191ab80499bded9e0668daa98faa849}{L\-B\-A} a, char $\ast$p)
\item 
int \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aa8c1cd442ebabe63060d75c8e8de8cad}{write\-S\-E\-C\-T\-O\-R} (\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_ae191ab80499bded9e0668daa98faa849}{L\-B\-A} a, char $\ast$p)
\item 
int \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a333a9ed0bf9a0bcb9500528e812881ab}{get\-C\-D} (void)
\item 
int \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a57e48dc648d410cdfe264eecdbd74afc}{get\-W\-P} (void)
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a5cc0f45eb89249d1ed7720e04a5a0130}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!\-\_\-\-\_\-\-S\-D\-M\-M\-C\-\_\-\-C\-\_\-\-\_\-@{\-\_\-\-\_\-\-S\-D\-M\-M\-C\-\_\-\-C\-\_\-\-\_\-}}
\index{\-\_\-\-\_\-\-S\-D\-M\-M\-C\-\_\-\-C\-\_\-\-\_\-@{\-\_\-\-\_\-\-S\-D\-M\-M\-C\-\_\-\-C\-\_\-\-\_\-}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{\-\_\-\-\_\-\-S\-D\-M\-M\-C\-\_\-\-C\-\_\-\-\_\-}]{\setlength{\rightskip}{0pt plus 5cm}\#define \-\_\-\-\_\-\-S\-D\-M\-M\-C\-\_\-\-C\-\_\-\-\_\-}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a5cc0f45eb89249d1ed7720e04a5a0130}


Definition at line 10 of file sdmmc.\-c.

\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ab71fa577a8bc96bd643f084e22eed47b}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!clock\-S\-P\-I@{clock\-S\-P\-I}}
\index{clock\-S\-P\-I@{clock\-S\-P\-I}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{clock\-S\-P\-I}]{\setlength{\rightskip}{0pt plus 5cm}\#define clock\-S\-P\-I(
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)~{\bf write\-S\-P\-I}(0x\-F\-F)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ab71fa577a8bc96bd643f084e22eed47b}


Definition at line 44 of file sdmmc.\-c.



Referenced by disable\-S\-D(), init\-Media(), and write\-S\-E\-C\-T\-O\-R().

\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ad7b4058b669998a3ca854c28167aa0a0}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!read\-S\-P\-I@{read\-S\-P\-I}}
\index{read\-S\-P\-I@{read\-S\-P\-I}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{read\-S\-P\-I}]{\setlength{\rightskip}{0pt plus 5cm}\#define read\-S\-P\-I(
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)~{\bf write\-S\-P\-I}(0x\-F\-F)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ad7b4058b669998a3ca854c28167aa0a0}


Definition at line 43 of file sdmmc.\-c.



Referenced by read\-S\-E\-C\-T\-O\-R(), send\-S\-D\-Cmd(), and write\-S\-E\-C\-T\-O\-R().



\subsection{Function Documentation}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a1531d2f76a265f4def4044d9c028c1a5}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!disable\-S\-D@{disable\-S\-D}}
\index{disable\-S\-D@{disable\-S\-D}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{disable\-S\-D}]{\setlength{\rightskip}{0pt plus 5cm}void disable\-S\-D (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a1531d2f76a265f4def4044d9c028c1a5}


Definition at line 46 of file sdmmc.\-c.



Referenced by init\-Media(), read\-S\-E\-C\-T\-O\-R(), and write\-S\-E\-C\-T\-O\-R().


\begin{DoxyCode}
47 \{
48     \hyperlink{p8_2pinguino_2core_2digitalw_8c_aa8b647552ab4292b55b14ab37b166908}{digitalwrite}(\hyperlink{p8_2pinguino_2libraries_2sd_2fileio_8h_a9470cb8f6ac9077bf21f815e37d13f09}{SDCS}, \hyperlink{p8_2pinguino_2core_2const_8h_a5bb885982ff66a2e0a0a45a8ee9c35e2}{HIGH});   \textcolor{comment}{// Deselected = SDCS high}
49     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ab71fa577a8bc96bd643f084e22eed47b}{clockSPI}();
50 \}
\end{DoxyCode}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aea80f1bdf2c4aba640129a965f4e071f}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!enable\-S\-D@{enable\-S\-D}}
\index{enable\-S\-D@{enable\-S\-D}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{enable\-S\-D}]{\setlength{\rightskip}{0pt plus 5cm}void enable\-S\-D (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aea80f1bdf2c4aba640129a965f4e071f}


Definition at line 52 of file sdmmc.\-c.



Referenced by init\-Media(), and send\-S\-D\-Cmd().


\begin{DoxyCode}
53 \{
54     \hyperlink{p8_2pinguino_2core_2digitalw_8c_aa8b647552ab4292b55b14ab37b166908}{digitalwrite}(\hyperlink{p8_2pinguino_2libraries_2sd_2fileio_8h_a9470cb8f6ac9077bf21f815e37d13f09}{SDCS}, \hyperlink{p8_2pinguino_2core_2const_8h_ab811d8c6ff3a505312d3276590444289}{LOW}); \textcolor{comment}{// Selected = SDCS low}
55 \}
\end{DoxyCode}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a333a9ed0bf9a0bcb9500528e812881ab}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!get\-C\-D@{get\-C\-D}}
\index{get\-C\-D@{get\-C\-D}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{get\-C\-D}]{\setlength{\rightskip}{0pt plus 5cm}int get\-C\-D (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a333a9ed0bf9a0bcb9500528e812881ab}


Definition at line 262 of file sdmmc.\-c.



Referenced by disk\-\_\-timerproc(), and mount().


\begin{DoxyCode}
263 \{
264     \textcolor{keywordflow}{return} \hyperlink{p8_2pinguino_2core_2const_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
265     \textcolor{comment}{//return (SDCD);}
266 \}
\end{DoxyCode}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a57e48dc648d410cdfe264eecdbd74afc}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!get\-W\-P@{get\-W\-P}}
\index{get\-W\-P@{get\-W\-P}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{get\-W\-P}]{\setlength{\rightskip}{0pt plus 5cm}int get\-W\-P (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a57e48dc648d410cdfe264eecdbd74afc}


Definition at line 271 of file sdmmc.\-c.



Referenced by disk\-\_\-timerproc(), and write\-S\-E\-C\-T\-O\-R().


\begin{DoxyCode}
272 \{
273     \textcolor{keywordflow}{return} \hyperlink{p8_2pinguino_2core_2const_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
274     \textcolor{comment}{//return (SDWP);}
275 \}
\end{DoxyCode}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a0a62982cc6fc4507eacea6f73767da72}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!init\-Media@{init\-Media}}
\index{init\-Media@{init\-Media}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{init\-Media}]{\setlength{\rightskip}{0pt plus 5cm}int init\-Media (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a0a62982cc6fc4507eacea6f73767da72}


Definition at line 107 of file sdmmc.\-c.



Referenced by mount().


\begin{DoxyCode}
108 \{
109     \textcolor{keywordtype}{int} i, r;
110 
111     \textcolor{comment}{// 1. with the card NOT selected     }
112     \textcolor{comment}{// Set DI and CS high}
113     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a1531d2f76a265f4def4044d9c028c1a5}{disableSD}(); 
114 
115     \textcolor{comment}{// 2. send 74 or more clock cycles to start up}
116     \textcolor{comment}{// apply 74 or more clock pulses to SCLK.}
117     \textcolor{comment}{// The card will enter its native operating mode and go ready to accept native commands.}
118     \textcolor{keywordflow}{for} (i=0; i<10; i++)
119         \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ab71fa577a8bc96bd643f084e22eed47b}{clockSPI}();
120 
121     \textcolor{comment}{// 3. now select the card}
122     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aea80f1bdf2c4aba640129a965f4e071f}{enableSD}();
123 
124     \textcolor{comment}{// 4. send a single RESET command}
125     \textcolor{comment}{// Send a CMD0 with CS low to reset the card.}
126     r = \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_af35781ed6bb5671aa7cf321e48ed0009}{sendSDCmd}(\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_ab702106cf3b3e96750b6845ded4e0299}{RESET}, 0);
127     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a1531d2f76a265f4def4044d9c028c1a5}{disableSD}();
128     \textcolor{keywordflow}{if} (r != 1)                \textcolor{comment}{// must return Idle}
129         \textcolor{keywordflow}{return} \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_a0d371bd9dc0df54489199aad563155b0}{E\_COMMAND\_ACK};   \textcolor{comment}{// comand rejected}
130 
131     \textcolor{comment}{// 5. send repeatedly INIT until Idle terminates}
132     \textcolor{keywordflow}{for} (i=0; i<\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_ab1ceea657d19e00656db1559099d9ba9}{I\_TIMEOUT}; i++) 
133     \{
134         r = \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_af35781ed6bb5671aa7cf321e48ed0009}{sendSDCmd}(\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_ab5889105dcd019008c9448dff61323f6}{INIT}, 0);
135         \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a1531d2f76a265f4def4044d9c028c1a5}{disableSD}();
136         \textcolor{keywordflow}{if} (!r) 
137             \textcolor{keywordflow}{break}; 
138     \} 
139     \textcolor{keywordflow}{if} (i == I\_TIMEOUT)   
140         \textcolor{keywordflow}{return} \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_a96c1fea55347ad0c3bf3f39c092bb0bb}{E\_INIT\_TIMEOUT};  \textcolor{comment}{// init timed out }
141 
142     \textcolor{comment}{// 6. increase speed }
143     SSPCON1bits.SSPEN = 0;  \textcolor{comment}{// Disable SPI}
144     SSPCON1 = SSPCON1 & 0b11110000; \textcolor{comment}{// SSPM<3:0> = 0000 = SPI Master mode, clock = FOSC/4}
145     SSPCON1bits.SSPEN = 1;  \textcolor{comment}{// Enable SPI}
146 
147     \textcolor{keywordflow}{return} 0;           
148 \} \textcolor{comment}{// init media}
\end{DoxyCode}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a469e8fffcf5a77dc542d8acea1cfea57}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!init\-S\-D@{init\-S\-D}}
\index{init\-S\-D@{init\-S\-D}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{init\-S\-D}]{\setlength{\rightskip}{0pt plus 5cm}void init\-S\-D (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a469e8fffcf5a77dc542d8acea1cfea57}


Definition at line 26 of file sdmmc.\-c.



Referenced by mount().


\begin{DoxyCode}
27 \{
28     \hyperlink{p8_2pinguino_2core_2digitalw_8c_aa8b647552ab4292b55b14ab37b166908}{digitalwrite}(\hyperlink{p8_2pinguino_2libraries_2sd_2fileio_8h_a9470cb8f6ac9077bf21f815e37d13f09}{SDCS}, \hyperlink{p8_2pinguino_2core_2const_8h_a5bb885982ff66a2e0a0a45a8ee9c35e2}{HIGH});   \textcolor{comment}{// initially keep the SD card disabled}
29     \hyperlink{digitalp_8c_a4b7fb3b918515dd8def26fd611013db2}{pinmode}(\hyperlink{p8_2pinguino_2libraries_2sd_2fileio_8h_a9470cb8f6ac9077bf21f815e37d13f09}{SDCS}, \hyperlink{p8_2pinguino_2core_2const_8h_a61a3c9a18380aafb6e430e79bf596557}{OUTPUT});     \textcolor{comment}{// make Card select an output pin}
30 
31     \textcolor{comment}{// SPI pin names are declared in pins.h}
32     \hyperlink{digitalp_8c_a4b7fb3b918515dd8def26fd611013db2}{pinmode}(SCK, \hyperlink{p8_2pinguino_2core_2const_8h_a61a3c9a18380aafb6e430e79bf596557}{OUTPUT});      \textcolor{comment}{// Master Mode : clock is output}
33     \hyperlink{digitalp_8c_a4b7fb3b918515dd8def26fd611013db2}{pinmode}(SDI, \hyperlink{p8_2pinguino_2core_2const_8h_a1bb283bd7893b9855e2f23013891fc82}{INPUT});
34     \hyperlink{digitalp_8c_a4b7fb3b918515dd8def26fd611013db2}{pinmode}(SDO, \hyperlink{p8_2pinguino_2core_2const_8h_a61a3c9a18380aafb6e430e79bf596557}{OUTPUT});
35 
36     \textcolor{comment}{// init the SPI module for a slow (safe) clock speed first}
37     SSPCON1bits.CKP = 0;        \textcolor{comment}{// Idle state for clock is a low level}
38     SSPSTATbits.CKE = 1;        \textcolor{comment}{// Transmit occurs on transition from active to Idle clock state}
39     SSPCON1 = SSPCON1 & 0b11110010; \textcolor{comment}{// SSPM<3:0> = 0010 = SPI Master mode, clock = FOSC/64}
40     SSPCON1bits.SSPEN = 1;  \textcolor{comment}{// Enables serial port and configures SCK, SDO, SDI and SS as serial port pins;}
41 \}   \textcolor{comment}{// initSD}
\end{DoxyCode}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aa852b20c06fce185a342322012a3b01e}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!read\-S\-E\-C\-T\-O\-R@{read\-S\-E\-C\-T\-O\-R}}
\index{read\-S\-E\-C\-T\-O\-R@{read\-S\-E\-C\-T\-O\-R}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{read\-S\-E\-C\-T\-O\-R}]{\setlength{\rightskip}{0pt plus 5cm}int read\-S\-E\-C\-T\-O\-R (
\begin{DoxyParamCaption}
\item[{{\bf L\-B\-A}}]{a, }
\item[{char $\ast$}]{p}
\end{DoxyParamCaption}
)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aa852b20c06fce185a342322012a3b01e}


Definition at line 154 of file sdmmc.\-c.



Referenced by mount(), read\-D\-A\-T\-A(), read\-D\-I\-R(), and read\-F\-A\-T().


\begin{DoxyCode}
155 \{
156     \textcolor{keywordtype}{int} r, i;
157 
158 \textcolor{preprocessor}{    #ifdef READ\_LED    }
159 \textcolor{preprocessor}{}    \hyperlink{p8_2pinguino_2core_2digitalw_8c_aa8b647552ab4292b55b14ab37b166908}{digitalwrite}(READ\_LED, 0);
160 \textcolor{preprocessor}{    #endif}
161 \textcolor{preprocessor}{}
162     \textcolor{comment}{// 1. send READ command}
163     r = \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_af35781ed6bb5671aa7cf321e48ed0009}{sendSDCmd}(\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_a549850eb399ab873a7a7c37696adcd5a}{READ\_SINGLE}, (a << 9));
164     \textcolor{keywordflow}{if} (r == 0)    \textcolor{comment}{// check if command was accepted}
165     \{  
166     \textcolor{comment}{// 2. wait for a response}
167     \textcolor{keywordflow}{for}(i=0; i<\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_a73e9971e06d8b2cad0e70db0ef35df42}{R\_TIMEOUT}; i++)
168     \{
169     r = \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ad7b4058b669998a3ca854c28167aa0a0}{readSPI}();     
170     \textcolor{keywordflow}{if} (r == \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_a5562e3e4189eff9e71305f172f2b515a}{DATA\_START}) 
171     \textcolor{keywordflow}{break};
172     \} 
173 
174     \textcolor{comment}{// 3. if it did not timeout, read 512 byte of data}
175     \textcolor{keywordflow}{if} (i != R\_TIMEOUT)
176     \{
177         i = 512;
178         \textcolor{keywordflow}{do}\{ 
179             *p++ = \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ad7b4058b669998a3ca854c28167aa0a0}{readSPI}();
180         \} \textcolor{keywordflow}{while} (--i>0);
181 
182         \textcolor{comment}{// 4. ignore CRC}
183         \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ad7b4058b669998a3ca854c28167aa0a0}{readSPI}();
184         \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ad7b4058b669998a3ca854c28167aa0a0}{readSPI}();
185 
186     \} \textcolor{comment}{// data arrived}
187 
188     \} \textcolor{comment}{// command accepted}
189 
190     \textcolor{comment}{// 5. remember to disable the card}
191     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a1531d2f76a265f4def4044d9c028c1a5}{disableSD}();
192 
193 \textcolor{preprocessor}{    #ifdef READLED}
194 \textcolor{preprocessor}{}    digital(READ\_LED, 1);
195 \textcolor{preprocessor}{    #endif}
196 \textcolor{preprocessor}{}
197     \textcolor{keywordflow}{return} (r == \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_a5562e3e4189eff9e71305f172f2b515a}{DATA\_START});    \textcolor{comment}{// return TRUE if successful}
198 \} \textcolor{comment}{// readSECTOR}
\end{DoxyCode}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_af35781ed6bb5671aa7cf321e48ed0009}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!send\-S\-D\-Cmd@{send\-S\-D\-Cmd}}
\index{send\-S\-D\-Cmd@{send\-S\-D\-Cmd}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{send\-S\-D\-Cmd}]{\setlength{\rightskip}{0pt plus 5cm}int send\-S\-D\-Cmd (
\begin{DoxyParamCaption}
\item[{unsigned char}]{c, }
\item[{unsigned}]{a}
\end{DoxyParamCaption}
)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_af35781ed6bb5671aa7cf321e48ed0009}


Definition at line 59 of file sdmmc.\-c.



Referenced by init\-Media(), read\-S\-E\-C\-T\-O\-R(), and write\-S\-E\-C\-T\-O\-R().


\begin{DoxyCode}
60 \{
61     \textcolor{keywordtype}{int} i, r;
62 
63     \textcolor{comment}{// enable SD card}
64     \textcolor{comment}{// CS low}
65     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aea80f1bdf2c4aba640129a965f4e071f}{enableSD}();
66 
67     \textcolor{comment}{// send a comand packet (6 bytes)}
68     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}{writeSPI}(\hyperlink{p8_2pinguino_2libraries_2_p_c_d8544_8c_aa0dd25f53b00986c159fb20de6894e51}{c} | 0x40);    \textcolor{comment}{// send command }
69     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}{writeSPI}(a>>24);       \textcolor{comment}{// msb of the address}
70     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}{writeSPI}(a>>16);       
71     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}{writeSPI}(a>>8);
72     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}{writeSPI}(a);           \textcolor{comment}{// lsb}
73 
74     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}{writeSPI}(0x95);        \textcolor{comment}{// send CMD0 CRC }
75 
76     \textcolor{comment}{// now wait for a response, allow for up to 8 bytes delay}
77     \textcolor{keywordflow}{for}(i=0; i<8; i++) 
78     \{
79         r = \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ad7b4058b669998a3ca854c28167aa0a0}{readSPI}();      
80         \textcolor{keywordflow}{if} (r != 0xFF) 
81             \textcolor{keywordflow}{break};
82     \}
83     \textcolor{keywordflow}{return} (r);         
84 
85     \textcolor{comment}{/* return response}
86 \textcolor{comment}{    FF - timeout }
87 \textcolor{comment}{    00 - command accepted}
88 \textcolor{comment}{    01 - command received, card in idle state after RESET}
89 \textcolor{comment}{}
90 \textcolor{comment}{    other codes:}
91 \textcolor{comment}{    bit 0 = Idle state}
92 \textcolor{comment}{    bit 1 = Erase Reset}
93 \textcolor{comment}{    bit 2 = Illegal command}
94 \textcolor{comment}{    bit 3 = Communication CRC error}
95 \textcolor{comment}{    bit 4 = Erase sequence error}
96 \textcolor{comment}{    bit 5 = Address error}
97 \textcolor{comment}{    bit 6 = Parameter error}
98 \textcolor{comment}{    bit 7 = Always 0}
99 \textcolor{comment}{    */}
100     \textcolor{comment}{// NOTE CSCD is still low!}
101 \} \textcolor{comment}{// sendSDCmd}
\end{DoxyCode}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aa8c1cd442ebabe63060d75c8e8de8cad}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!write\-S\-E\-C\-T\-O\-R@{write\-S\-E\-C\-T\-O\-R}}
\index{write\-S\-E\-C\-T\-O\-R@{write\-S\-E\-C\-T\-O\-R}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{write\-S\-E\-C\-T\-O\-R}]{\setlength{\rightskip}{0pt plus 5cm}int write\-S\-E\-C\-T\-O\-R (
\begin{DoxyParamCaption}
\item[{{\bf L\-B\-A}}]{a, }
\item[{char $\ast$}]{p}
\end{DoxyParamCaption}
)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_aa8c1cd442ebabe63060d75c8e8de8cad}


Definition at line 204 of file sdmmc.\-c.



Referenced by write\-D\-A\-T\-A(), write\-D\-I\-R(), and write\-F\-A\-T().


\begin{DoxyCode}
205 \{
206     \textcolor{keywordtype}{unsigned} r, i;
207 
208     \textcolor{comment}{// 0. check Write Protect}
209     \textcolor{keywordflow}{if} (\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a57e48dc648d410cdfe264eecdbd74afc}{getWP}())
210         \textcolor{keywordflow}{return} \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_abb508ea8227673f419e9fe3a86c30d8e}{FAIL};
211 
212     \textcolor{comment}{// 1. send WRITE command}
213     r = \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_af35781ed6bb5671aa7cf321e48ed0009}{sendSDCmd}(\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_aa44d51cd8fac15d4a24ccf8c55ad7da5}{WRITE\_SINGLE}, (a << 9));
214     \textcolor{keywordflow}{if} (r == 0)    \textcolor{comment}{// check if command was accepted}
215     \{  
216         \textcolor{comment}{// 2. send data}
217         \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}{writeSPI}(\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_a5562e3e4189eff9e71305f172f2b515a}{DATA\_START});
218 
219         \textcolor{comment}{// send 512 bytes of data}
220         \textcolor{keywordflow}{for}(i=0; i<512; i++)
221         \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}{writeSPI}(*p++);
222 
223         \textcolor{comment}{// 3. send dummy CRC}
224         \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ab71fa577a8bc96bd643f084e22eed47b}{clockSPI}();
225         \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ab71fa577a8bc96bd643f084e22eed47b}{clockSPI}();
226 
227         \textcolor{comment}{// 4. check if data accepted}
228         r = \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ad7b4058b669998a3ca854c28167aa0a0}{readSPI}(); 
229         \textcolor{keywordflow}{if} ((r & 0xf) == \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_a11a962adddfd0449f2401bbefeac89bd}{DATA\_ACCEPT})
230         \{   
231 \textcolor{preprocessor}{            #ifdef WRITE\_LED    }
232 \textcolor{preprocessor}{}            \hyperlink{p8_2pinguino_2core_2digitalw_8c_aa8b647552ab4292b55b14ab37b166908}{digitalwrite}(WRITE\_LED, 0);
233 \textcolor{preprocessor}{            #endif}
234 \textcolor{preprocessor}{}
235             \textcolor{comment}{// 5. wait for write completion}
236             \textcolor{keywordflow}{for}(i=0; i<\hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_a5d89c559dd2f905ae0f8f9d16b16647d}{W\_TIMEOUT}; i++)
237             \{ 
238                 r = \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_ad7b4058b669998a3ca854c28167aa0a0}{readSPI}();
239                 \textcolor{keywordflow}{if} (r != 0 )
240                     \textcolor{keywordflow}{break};
241             \} 
242 \textcolor{preprocessor}{            #ifdef WRITE\_LED}
243 \textcolor{preprocessor}{}            \hyperlink{p8_2pinguino_2core_2digitalw_8c_aa8b647552ab4292b55b14ab37b166908}{digitalwrite}(WRITE\_LED, 1);
244 \textcolor{preprocessor}{            #endif}
245 \textcolor{preprocessor}{}        \} \textcolor{comment}{// accepted}
246         \textcolor{keywordflow}{else}
247         \{
248             r = \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8h_abb508ea8227673f419e9fe3a86c30d8e}{FAIL};
249         \}
250     \} \textcolor{comment}{// command accepted}
251 
252     \textcolor{comment}{// 6. disable the card}
253     \hyperlink{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a1531d2f76a265f4def4044d9c028c1a5}{disableSD}();
254 
255     \textcolor{keywordflow}{return} (r);      \textcolor{comment}{// return TRUE if successful}
256 \} \textcolor{comment}{// writeSECTOR}
\end{DoxyCode}
\hypertarget{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}{\index{p8/pinguino/libraries/sd/sdmmc.\-c@{p8/pinguino/libraries/sd/sdmmc.\-c}!write\-S\-P\-I@{write\-S\-P\-I}}
\index{write\-S\-P\-I@{write\-S\-P\-I}!p8/pinguino/libraries/sd/sdmmc.c@{p8/pinguino/libraries/sd/sdmmc.\-c}}
\subsubsection[{write\-S\-P\-I}]{\setlength{\rightskip}{0pt plus 5cm}unsigned char write\-S\-P\-I (
\begin{DoxyParamCaption}
\item[{unsigned char}]{b}
\end{DoxyParamCaption}
)}}\label{p8_2pinguino_2libraries_2sd_2sdmmc_8c_a6a1a198a7f27db28761172fa4426daf3}


Definition at line 19 of file sdmmc.\-c.



Referenced by send\-S\-D\-Cmd(), and write\-S\-E\-C\-T\-O\-R().


\begin{DoxyCode}
20 \{
21     SSPBUF = b;                     \textcolor{comment}{// write to buffer for TX}
22     \textcolor{keywordflow}{while}(!SSPSTATbits.BF);     \textcolor{comment}{// wait transfer complete}
23     \textcolor{keywordflow}{return} SSPBUF;                  \textcolor{comment}{// read the received value}
24 \}   \textcolor{comment}{// writeSPI}
\end{DoxyCode}
